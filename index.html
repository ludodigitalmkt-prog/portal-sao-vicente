<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal S√£o Vicente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: { primary: 'var(--color-primary, #1E40AF)', secondary: 'var(--color-secondary, #F97316)', medical: 'var(--color-medical, #E0F2FE)' },
                    fontFamily: { sans: ['var(--font-family, Inter)', 'sans-serif'] },
                    borderRadius: { 'custom': 'var(--border-radius, 1.5rem)' },
                    animation: { 
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 
                        'fade-in': 'fadeIn 0.4s ease-out', 
                        'pop-in': 'popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'ticker': 'ticker 25s linear infinite',
                        'spin-slow': 'spin 8s linear infinite'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(100%)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        ticker: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Roboto:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDK (V8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { 
            --color-primary: #1E40AF; 
            --color-secondary: #F97316; 
            --color-medical: #E0F2FE; 
            --color-bg: #F8FAFC; 
            --font-family: 'Inter';
            --border-radius: 1.5rem;
            --card-transition: all 0.3s ease;
        }
        
        body { font-family: var(--font-family), sans-serif; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; background-color: var(--color-bg); }
        body.dark { background-color: #0f172a; } 

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .card-hover { transition: var(--card-transition); border-radius: var(--border-radius); }
        .card-hover:hover { transform: translateY(-5px) scale(1.02); z-index: 10; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .glass-modal { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); }
        .dark .glass-modal { background: rgba(15, 23, 42, 0.85); }
        .ticker-container { display: flex; overflow: hidden; white-space: nowrap; width: 100%; align-items: center; }
        .rounded-custom { border-radius: var(--border-radius) !important; }

        /* Tabela de Matriz Premium (Price Table Design) */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        .matrix-table th { padding: 1.5rem 1rem; color: white; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; text-align: center; border: none; }
        .matrix-table th:first-child { border-radius: 1rem 0 0 1rem; background-color: #1e293b; text-align: left; position: sticky; left: 0; z-index: 30; }
        .matrix-table th:last-child { border-radius: 0 1rem 1rem 0; }
        .matrix-row { background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .matrix-row:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(0,0,0,0.1); z-index: 20; }
        .dark .matrix-row { background-color: #1e293b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .matrix-row td { padding: 1rem; text-align: center; vertical-align: middle; border: none; }
        .matrix-row td:first-child { background-color: #1e293b; color: white; font-weight: bold; border-radius: 1rem 0 0 1rem; text-align: left; position: sticky; left: 0; z-index: 20; border-left: 6px solid var(--color-primary); }
        .matrix-row td:last-child { border-radius: 0 1rem 1rem 0; }
    </style>
</head>
<body class="text-gray-800 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // ==========================================
        // üõë COLE AS SUAS CHAVES DO FIREBASE ABAIXO üõë
        // ==========================================
        const firebaseConfig = {
            apiKey: "COLE_AQUI",
            authDomain: "COLE_AQUI",
            projectId: "COLE_AQUI",
            storageBucket: "COLE_AQUI",
            messagingSenderId: "COLE_AQUI",
            appId: "COLE_AQUI"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey !== "" && firebaseConfig.apiKey !== "COLE_AQUI" && !firebaseConfig.apiKey.includes("AIzaSySuaChaveGiganteAqui");
        
        let db, auth;
        if (isFirebaseConfigured) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            auth = firebase.auth();
        }

        // --- SISTEMA ANTI-CRASH GLOBAL DE SEGURAN√áA M√ÅXIMA ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Escudo ativado:", error); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-6 w-full">
                            <div className="bg-white dark:bg-slate-800 p-10 rounded-[2rem] shadow-2xl text-center max-w-xl border border-red-200">
                                <div className="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6"><i className="ph-fill ph-warning-circle text-6xl"></i></div>
                                <h2 className="text-2xl font-black mb-4">Esta sec√ß√£o est√° vazia ou a carregar</h2>
                                <p className="text-gray-500 mb-8">Pode ter faltado algum dado ou a sua configura√ß√£o ainda est√° em processamento.</p>
                                <button onClick={() => { this.setState({ hasError: false }); window.location.reload(); }} className="w-full bg-red-600 text-white py-4 rounded-xl font-black">Tentar Novamente</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const safeString = (val) => {
            if (val === null || val === undefined) return '';
            return String(val); // Removido o .trim() para permitir espa√ßos ao digitar!
        };

        const formatImageUrl = (url) => {
            const strUrl = safeString(url).trim();
            if (!strUrl) return '';
            if (strUrl.includes('drive.google.com')) {
                const match = strUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || strUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
            }
            return strUrl;
        };

        // SCHEMAS DEFINITIVOS E ROBUSTOS
        const tabSchemas = {
            'CORPO CLINICO': ['ID', 'M√©dico', 'Especialidade', 'Segmento', 'C√≥digo UNIMED', 'CRM', 'Cor_Selo', 'Foto_URL'],
            'EXAMES DE IMAGEM': ['ID', 'Categoria', 'C√≥digo', 'Nome do Exame', 'Profissionais', 'Idade Permitida', 'Observa√ß√µes', 'Imagem_URL'],
            'EXAMES DE IMAGEM E OUTROS': ['ID', 'C√≥digo', 'Descri√ß√£o', 'Valor', 'Prazo de Laudo', 'Onde Encontrar', 'Imagem_URL'],
            'CONSULTA E PROCEDIMENTOS': ['ID', 'C√≥digo', 'Consulta/Procedimento', 'Descri√ß√£o', 'Preparo', 'Material Utilizado', 'Valor Particular', 'Imagem_URL'],
            'EXAMES LABORATORIAIS': ['ID', 'C√≥digo', 'Procedimento', 'Valor', 'Prazo de Libera√ß√£o', 'Preparo', 'Motivo_Indicacao'],
            'CONTATOS': ['ID', 'Tipo', 'Local_Setor', 'Nome_Contato', 'Valor_Contato', 'Anotacoes'], // Atualizado para nova aba de contatos
            'SENHAS E LOGINS GERAIS': ['ID', 'Nome do Sistema', 'Link do Sistema', 'Login', 'Senha', 'Observa√ß√µes'],
            'REMO√á√ïES': ['ID', 'Nome do Hospital/Cl√≠nica', 'Contato', 'Local', 'Informa√ß√µes Importantes', 'Conv√™nios Atendidos', 'Imagem_URL'],
            'INSTITUTOS': ['ID', 'Tabela_Instituto', 'Profissional', 'Especialidade', 'CRM_URA', 'Valores'],
            'NOVIDADES_E_EVENTOS': ['ID', 'Tipo', 'T√≠tulo', 'Mensagem', 'Data de Publica√ß√£o', 'Imagem_URL'],
            'CONTROLE_ATENDIMENTOS': ['ID', 'Profissional', 'Conv√™nio', 'Qtd_Atual', 'Limite_Max'],
            'USUARIOS': ['ID', 'Nome Completo', 'E-mail', 'Senha', 'N√≠vel de Acesso', 'Data de Nascimento', 'Foto_Perfil_URL', 'Status'],
            'ESCALAS': ['ID', 'Tipo_Profissional', 'Nome_Profissional', 'Data', 'Turno', 'Horario', 'Unidade', 'Setor_Consultorio', 'Status', 'Tipo_Atendimento'],
            'CHAT_MENSAGENS': ['ID', 'Data_Hora', 'Nome', 'Mensagem', 'Destinatario'],
            'LEMBRETES_HORA': ['ID', 'Hora', 'Mensagem'],
            'CONFIGURACOES': ['ID', 'Chave', 'Valor'],
            'MURAL_AVISOS': ['ID', 'Layout', 'T√≠tulo', 'Subt√≠tulo', 'Imagem_URL', 'Link', 'Ativo']
        };

        const api = {
            fetch: async (colName) => {
                if(!isFirebaseConfigured) return [];
                try {
                    const snap = await db.collection(colName).get();
                    return snap.docs.map(doc => ({ ID: doc.id, ...doc.data() }));
                } catch (e) { return []; }
            },
            fetchAll: async () => {
                if(!isFirebaseConfigured) return {};
                let allData = {};
                for (let c of Object.keys(tabSchemas)) {
                    try {
                        const snap = await db.collection(c).get();
                        allData[c] = snap.docs.map(doc => ({ ID: doc.id, ...doc.data() }));
                    } catch(e) {}
                }
                return allData;
            },
            login: async (email, password) => {
                if(!isFirebaseConfigured) return { success: false, message: 'Adicione suas chaves do Firebase na Linha 98 do c√≥digo.' };
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    const userDoc = await db.collection('USUARIOS').where('E-mail', '==', email).get();
                    let userData = { 'E-mail': email, 'Nome Completo': email.split('@')[0], 'N√≠vel de Acesso': 'Admin' };
                    if (!userDoc.empty) {
                        userData = { ID: userDoc.docs[0].id, ...userDoc.docs[0].data() };
                        if (userData.Status && String(userData.Status).toLowerCase() !== 'ativo') {
                            await auth.signOut(); return { success: false, message: 'Usu√°rio inativo.' };
                        }
                    }
                    return { success: true, user: userData };
                } catch (error) { return { success: false, message: 'E-mail ou senha incorretos.' }; }
            },
            saveRecord: async (colName, data, isEdit) => {
                if(!isFirebaseConfigured) return { success: false };
                try {
                    let docData = { ...data };
                    // Limpar espa√ßos vazios NAS PONTAS apenas ao salvar
                    Object.keys(docData).forEach(k => { if(typeof docData[k] === 'string') docData[k] = docData[k].trim(); });
                    
                    let id = docData.ID; delete docData.ID;
                    Object.keys(docData).forEach(key => docData[key] === undefined && delete docData[key]);

                    if (isEdit && id) await db.collection(colName).doc(id).update(docData);
                    else await db.collection(colName).add(docData);
                    return { success: true };
                } catch (e) { return { success: false }; }
            },
            deleteRecord: async (colName, id) => {
                if(!isFirebaseConfigured) return { success: false };
                try { await db.collection(colName).doc(id).delete(); return { success: true }; } 
                catch (e) { return { success: false }; }
            }
        };

        // --- MODAL FORMULARIO BLINDADO ---
        const ModalForm = ({ title, schema, formData, setFormData, onSave, onClose, loading }) => {
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 glass-modal animate-fade-in" onMouseDown={onClose}>
                    <div className="bg-white dark:bg-slate-800 rounded-custom w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl animate-pop-in overflow-hidden border border-gray-100 dark:border-slate-700" onMouseDown={e => e.stopPropagation()}>
                        <div className="p-6 bg-gray-50 dark:bg-slate-900 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center shrink-0">
                            <h3 className="text-2xl font-black flex items-center gap-3 text-gray-900 dark:text-white"><div className="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center"><i className={`ph-bold ${formData?.ID ? 'ph-pencil-simple' : 'ph-plus'}`}></i></div> {formData?.ID ? 'Editar' : 'Novo'} {title}</h3>
                            <button onClick={onClose} className="w-10 h-10 rounded-full bg-gray-200 dark:bg-slate-700 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i className="ph-bold ph-x text-lg"></i></button>
                        </div>
                        <div className="p-8 overflow-y-auto flex-1 custom-scrollbar">
                            <form id="gen-form" onSubmit={onSave} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {(schema || []).filter(col => safeString(col) !== 'ID').map((col, idx) => {
                                    const colName = safeString(col);
                                    const cLower = colName.toLowerCase();
                                    const isLong = cLower.includes('descri√ß√£o') || cLower.includes('anota√ß√µes') || cLower.includes('mensagem') || cLower.includes('preparo') || cLower.includes('url') || cLower.includes('site') || cLower.includes('motivo');
                                    
                                    return (
                                        <div key={idx} className={isLong ? 'md:col-span-2' : ''}>
                                            <label className="block text-xs font-black text-gray-400 dark:text-slate-400 mb-2 uppercase tracking-widest">{colName}</label>
                                            
                                            {colName === 'Layout' && title.includes('Aviso') ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="Padr√£o">Padr√£o</option><option value="Imagem Grande">Imagem Grande (Banner)</option><option value="S√≥ Texto">S√≥ Texto</option>
                                                </select>
                                            ) : colName === 'Tipo' && title.includes('Contato') ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="Ramal">Ramal Interno</option><option value="Email">E-mail</option><option value="Telefone">Telefone Externo</option>
                                                </select>
                                            ) : colName.includes('?') || colName === 'Status' || colName === 'Ativo' ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="">Selecione...</option><option value="Sim">Sim</option><option value="N√£o">N√£o</option><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option>
                                                </select>
                                            ) : colName === 'N√≠vel de Acesso' ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="">Selecione...</option><option value="Colaborador">Colaborador</option><option value="Supervisor">Supervisor</option><option value="Admin">Admin</option>
                                                </select>
                                            ) : colName.includes('Cor') ? (
                                                <div className="flex items-center gap-3 bg-gray-50 dark:bg-slate-900 p-3 rounded-custom border border-gray-200 dark:border-slate-700">
                                                    <input type="color" className="w-10 h-10 rounded-xl cursor-pointer border-0 bg-transparent" value={safeString(formData[colName]) || '#1E40AF'} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} />
                                                    <span className="font-mono text-sm font-bold text-gray-500">{safeString(formData[colName]) || 'Cor Padr√£o'}</span>
                                                </div>
                                            ) : isLong && !cLower.includes('url') && !cLower.includes('site') ? (
                                                <textarea className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary min-h-[120px] font-medium text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} placeholder={`Detalhes...`}></textarea>
                                            ) : (
                                                <input type={cLower.includes('senha') ? 'text' : 'text'} className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} placeholder={`Preencha ${cLower}`} />
                                            )}
                                        </div>
                                    )
                                })}
                            </form>
                        </div>
                        <div className="p-6 border-t border-gray-100 dark:border-slate-700 flex justify-end gap-3 bg-white dark:bg-slate-800 shrink-0">
                            <button type="button" onClick={onClose} className="font-bold text-gray-500 px-8 py-4 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-custom transition">Cancelar</button>
                            <button type="submit" form="gen-form" disabled={loading} className="bg-primary hover:opacity-90 text-white font-black px-10 py-4 rounded-custom shadow-xl shadow-primary/30 transition transform hover:-translate-y-1 flex items-center gap-2">
                                {loading ? <i className="ph animate-spin ph-spinner text-xl"></i> : <i className="ph-bold ph-floppy-disk text-xl"></i>} {loading ? 'Salvando...' : 'Salvar'}
                            </button>
                        </div>
                    </div>
                </div>
            )
        };

        // --- VIEWS TOTALMENTE REFORMULADAS ---

        const SplitView = ({ data, canEdit, openModal, handleDelete, schema, titleLabel, fieldsLeft, fieldsRight, imageField, descField }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            const [selected, setSelected] = useState(null);
            
            const filtered = safeData.filter(d => d && typeof d === 'object' && Object.values(d).some(v => safeString(v).toLowerCase().includes(search.toLowerCase())));
            useEffect(() => { if(filtered.length > 0 && !selected) setSelected(filtered[0]); }, [filtered]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-[2rem] shadow-sm border border-gray-100 dark:border-slate-700">
                        <div className="relative w-full sm:w-96"><i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-lg"></i><input type="text" placeholder="Buscar..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-3.5 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" /></div>
                        {canEdit && <button onClick={()=>openModal(null, schema)} className="bg-primary text-white px-6 py-3.5 rounded-full font-black shadow-lg hover:-translate-y-1 transition flex items-center gap-2"><i className="ph-bold ph-plus text-lg"></i> Novo Item</button>}
                    </div>
                    <div className="flex flex-col lg:flex-row gap-8 items-start">
                        <div className="w-full lg:w-1/2 xl:w-5/12 space-y-3 h-[75vh] overflow-y-auto custom-scrollbar pr-2 pb-10">
                            {filtered.map((item, i) => (
                                <div key={i} onClick={() => setSelected(item)} className={`p-5 rounded-3xl border-2 cursor-pointer transition-all ${selected?.ID === item.ID ? 'bg-blue-50 dark:bg-slate-800 border-primary shadow-lg transform scale-[1.02]' : 'bg-white dark:bg-slate-900 border-gray-100 dark:border-slate-700 hover:border-blue-200'}`}>
                                    <span className="text-[10px] font-black text-gray-400 bg-gray-100 dark:bg-slate-800 px-2 py-1 rounded-md mb-2 inline-block uppercase tracking-widest">{safeString(item[fieldsLeft[0]]) || '-'}</span>
                                    <h3 className="font-black text-lg leading-tight text-gray-900 dark:text-white">{safeString(item[titleLabel]) || 'Sem Nome'}</h3>
                                    {fieldsLeft[1] && <p className="text-sm font-bold text-primary mt-2">{safeString(item[fieldsLeft[1]])}</p>}
                                </div>
                            ))}
                            {filtered.length===0 && <div className="p-10 text-center text-gray-400 font-bold border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-3xl">Nenhum item.</div>}
                        </div>
                        <div className="w-full lg:w-1/2 xl:w-7/12 sticky top-6">
                            {selected ? (
                                <div className="bg-white dark:bg-slate-800 rounded-[2.5rem] shadow-2xl border border-gray-100 dark:border-slate-700 p-8 animate-pop-in">
                                    {imageField && selected[imageField] && <img src={formatImageUrl(selected[imageField])} className="w-full h-48 object-cover rounded-2xl mb-6 shadow-sm" />}
                                    <h2 className="text-3xl font-black mb-6 leading-tight text-gray-900 dark:text-white">{safeString(selected[titleLabel])}</h2>
                                    <div className="space-y-6">
                                        {descField && selected[descField] && (
                                            <div>
                                                <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Informa√ß√µes Gerais</h4>
                                                <p className="font-medium bg-gray-50 dark:bg-slate-900 p-5 rounded-2xl text-gray-700 dark:text-slate-300">{safeString(selected[descField])}</p>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-2 gap-4">
                                            {fieldsRight.map((f, idx) => selected[f] ? (
                                                <div key={idx} className="bg-gray-50 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 p-5 rounded-2xl">
                                                    <h4 className="text-xs font-black text-primary uppercase tracking-widest mb-2">{f}</h4>
                                                    <p className="font-bold text-gray-800 dark:text-slate-200 text-sm">{f==='Valor'&&selected[f]?'R$ ':''}{safeString(selected[f])}</p>
                                                </div>
                                            ) : null)}
                                        </div>
                                        {canEdit && (
                                            <div className="flex gap-4 pt-6 border-t border-gray-100 dark:border-slate-700">
                                                <button onClick={()=>openModal(selected, schema)} className="flex-1 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 font-black py-4 rounded-2xl transition flex items-center justify-center gap-2"><i className="ph-bold ph-pencil-simple text-xl"></i> Editar</button>
                                                <button onClick={()=>{if(confirm('Tem certeza?')) { handleDelete(selected.ID); setSelected(null); }}} className="flex-1 bg-red-50 dark:bg-red-900/30 text-red-600 font-black py-4 rounded-2xl transition flex items-center justify-center gap-2"><i className="ph-bold ph-trash text-xl"></i> Excluir</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : <div className="h-64 flex items-center justify-center text-gray-400 font-bold border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-3xl">Selecione um item ao lado.</div>}
                        </div>
                    </div>
                </div>
            )
        };

        const CategoryCardsView = ({ data, canEdit, openModal, handleDelete, schema, categoryField, titleField, imageField }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            const [selectedCat, setSelectedCat] = useState(null);
            
            const grupos = useMemo(() => {
                const map = {};
                safeData.forEach(c => {
                    if(!c || typeof c !== 'object') return;
                    const cat = safeString(c[categoryField]) || 'Geral';
                    if(!map[cat]) map[cat] = [];
                    if(Object.values(c).some(v=>safeString(v).toLowerCase().includes(search.toLowerCase()))) map[cat].push(c);
                });
                return map;
            }, [safeData, search]);

            if (selectedCat) {
                const items = grupos[selectedCat] || [];
                return (
                    <div className="space-y-6 animate-fade-in">
                        <button onClick={()=>setSelectedCat(null)} className="font-black text-gray-500 hover:text-primary flex items-center gap-2 bg-white dark:bg-slate-800 px-6 py-3 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 transition hover:-translate-x-1"><i className="ph-bold ph-arrow-left"></i> Voltar para Pastas</button>
                        <div className="bg-white dark:bg-slate-800 rounded-[2.5rem] shadow-sm border border-gray-100 dark:border-slate-700 p-8">
                            <div className="flex justify-between items-center mb-8 border-b dark:border-slate-700 pb-6">
                                <h2 className="text-3xl font-black text-gray-900 dark:text-white flex items-center gap-4"><div className="p-3 bg-blue-50 text-blue-600 rounded-2xl"><i className="ph-fill ph-folder-open"></i></div> {selectedCat}</h2>
                                {canEdit && <button onClick={()=>openModal({[categoryField]: selectedCat}, schema)} className="bg-primary/10 text-primary font-black px-6 py-3 rounded-2xl hover:bg-primary hover:text-white transition">Adicionar Novo</button>}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {items.map((item, i) => (
                                    <div key={i} className="group bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-3xl p-6 card-hover relative flex flex-col">
                                        {imageField && item[imageField] && <img src={formatImageUrl(item[imageField])} className="w-16 h-16 rounded-2xl object-cover mb-4 shadow-sm border-2 border-white dark:border-slate-600" />}
                                        <h4 className="font-black text-xl leading-tight mb-3 text-gray-900 dark:text-white">{safeString(item[titleField]) || 'Sem Nome'}</h4>
                                        <div className="space-y-2 mt-auto">
                                            {schema.filter(s=>s!=='ID' && s!==categoryField && s!==titleField && s!==imageField).map(k => item[k] ? (
                                                <p key={k} className="text-sm font-medium text-gray-600 dark:text-slate-400"><strong className="text-xs uppercase tracking-widest text-gray-400 block">{k}</strong> {safeString(item[k])}</p>
                                            ) : null)}
                                        </div>
                                        {canEdit && (
                                            <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={()=>openModal(item, schema)} className="p-2 text-blue-600 bg-blue-100 dark:bg-blue-900/30 rounded-xl hover:bg-blue-600 hover:text-white transition"><i className="ph-bold ph-pencil-simple"></i></button>
                                                <button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="p-2 text-red-600 bg-red-100 dark:bg-red-900/30 rounded-xl hover:bg-red-600 hover:text-white transition"><i className="ph-bold ph-trash"></i></button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-[2rem] shadow-sm border border-gray-100 dark:border-slate-700">
                        <div className="relative w-full sm:w-96"><i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-xl"></i><input type="text" placeholder="Buscar..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" /></div>
                        {canEdit && <button onClick={()=>openModal(null, schema)} className="bg-primary text-white px-8 py-4 rounded-full font-black shadow-lg hover:-translate-y-1 transition flex items-center gap-2"><i className="ph-bold ph-plus text-xl"></i> Nova Categoria/Item</button>}
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {Object.keys(grupos).map(cat => (
                            <div key={cat} onClick={()=>setSelectedCat(cat)} className="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-sm border border-gray-100 dark:border-slate-700 card-hover cursor-pointer flex flex-col items-center justify-center text-center h-48 gap-4 group relative overflow-hidden">
                                <div className="w-16 h-16 rounded-[1.2rem] bg-blue-50 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-3xl shadow-inner group-hover:scale-110 transition"><i className="ph-fill ph-folder-open"></i></div>
                                <div><h3 className="font-black text-lg leading-tight text-gray-800 dark:text-white">{cat}</h3><span className="text-xs font-bold text-gray-400">{grupos[cat].length} itens</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ContatosViewTabs = ({ data, canEdit, openModal, handleDelete, schema }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            const [activeTab, setActiveTab] = useState('Ramal'); // Ramal, Email, Telefone
            
            const filtered = safeData.filter(c => c && safeString(c.Tipo) === activeTab && Object.values(c).some(v=>safeString(v).toLowerCase().includes(search.toLowerCase())));

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 rounded-custom p-4 shadow-sm border border-gray-100 dark:border-slate-700 flex justify-between items-center gap-4">
                        <div className="flex bg-gray-50 dark:bg-slate-900 p-2 rounded-2xl gap-2 w-full md:w-auto">
                            <button onClick={()=>setActiveTab('Ramal')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Ramal'?'bg-white dark:bg-slate-800 text-primary shadow-md':'text-gray-500'}`}>üìû Ramais Internos</button>
                            <button onClick={()=>setActiveTab('Email')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Email'?'bg-white dark:bg-slate-800 text-secondary shadow-md':'text-gray-500'}`}>üìß E-mails</button>
                            <button onClick={()=>setActiveTab('Telefone')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Telefone'?'bg-white dark:bg-slate-800 text-green-600 shadow-md':'text-gray-500'}`}>üì± Tel. Externos</button>
                        </div>
                        {canEdit && <button onClick={()=>openModal({Tipo: activeTab}, schema)} className="bg-primary text-white font-black px-6 py-3 rounded-xl shadow-md hover:-translate-y-1 transition"><i className="ph-bold ph-plus"></i> Novo Contato</button>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filtered.map((item, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-[2rem] p-6 shadow-sm card-hover relative group">
                                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50 dark:bg-slate-900 px-3 py-1 rounded-full mb-3 inline-block">{safeString(item.Local_Setor) || 'Sem Local'}</span>
                                <h3 className="font-black text-xl text-gray-900 dark:text-white mb-1">{safeString(item.Nome_Contato) || 'Sem Nome'}</h3>
                                <p className={`text-xl font-black mt-3 p-3 rounded-xl ${activeTab==='Ramal'?'bg-blue-50 text-blue-700':activeTab==='Email'?'bg-orange-50 text-orange-700':'bg-green-50 text-green-700'}`}>{safeString(item.Valor_Contato)}</p>
                                {item.Anotacoes && <p className="text-xs font-medium text-gray-500 mt-4 leading-tight">{safeString(item.Anotacoes)}</p>}
                                
                                {canEdit && (
                                    <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onClick={()=>openModal(item, schema)} className="p-2 text-blue-600 bg-white shadow rounded-lg hover:bg-blue-600 hover:text-white"><i className="ph-bold ph-pencil-simple"></i></button>
                                        <button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="p-2 text-red-600 bg-white shadow rounded-lg hover:bg-red-600 hover:text-white"><i className="ph-bold ph-trash"></i></button>
                                    </div>
                                )}
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="col-span-full p-20 text-center text-gray-400 font-bold border-2 border-dashed rounded-3xl">Nenhum {activeTab} cadastrado.</div>}
                    </div>
                </div>
            )
        };

        const ChatModerno = ({ chatData, user, onSaveChat, onRefresh }) => {
            const [msg, setMsg] = useState('');
            const [activeRoom, setActiveRoom] = useState('Geral'); // Geral ou ID do Supervisor
            
            const isAdmin = user && ['admin', 'supervisor'].some(r => safeString(user['N√≠vel de Acesso']).toLowerCase().includes(r));
            const myName = safeString(user['Nome Completo']);
            const myId = user.ID;

            // Busca supervisores se o usu√°rio for colaborador
            // Busca colaboradores que mandaram msg se o usu√°rio for supervisor
            const chatLog = Array.isArray(chatData) ? chatData : [];
            
            // F√≥rum Geral
            const isGeral = activeRoom === 'Geral';
            const mensagensRoom = chatLog.filter(m => {
                if(isGeral) return m.Destinatario === 'Geral';
                // Chat Direto: Eu sou o rementente para Room, ou Room √© remetente para mim
                return (m.Nome === myName && m.Destinatario === activeRoom) || (m.Nome === activeRoom && m.Destinatario === myName);
            }).sort((a,b) => new Date(a.Data_Hora) - new Date(b.Data_Hora)); // Sort simplificado

            // Obter Lista de Contatos para Chat Privado
            // Simplificado para esta view: Qualquer pessoa pode falar com a "Supervis√£o" como entidade
            const canais = ['Geral', isAdmin ? 'Caixa de Entrada' : 'Supervis√£o'];

            const handleSend = async (e) => {
                e.preventDefault(); if(!msg)return;
                let dest = activeRoom;
                if(!isAdmin && activeRoom === 'Supervis√£o') dest = 'Supervis√£o';
                
                await onSaveChat('CHAT_MENSAGENS', {ID:'', Data_Hora:new Date().toISOString(), Nome:myName, Mensagem:msg, Destinatario:dest}, false);
                setMsg(''); onRefresh();
            };

            return (
                <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-xl border border-gray-100 dark:border-slate-700 h-[80vh] flex overflow-hidden animate-fade-in">
                    <div className="w-1/3 border-r border-gray-100 dark:border-slate-700 bg-gray-50/50 dark:bg-slate-900/50 flex flex-col">
                        <div className="p-6 border-b border-gray-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                            <h2 className="text-2xl font-black flex items-center gap-3"><i className="ph-fill ph-chats-circle text-primary"></i> Comunica√ß√£o</h2>
                        </div>
                        <div className="p-4 space-y-2 overflow-y-auto">
                            <div onClick={()=>setActiveRoom('Geral')} className={`p-4 rounded-2xl cursor-pointer font-bold flex items-center gap-3 transition ${activeRoom==='Geral'?'bg-primary text-white shadow-md':'hover:bg-gray-100 dark:hover:bg-slate-800'}`}>
                                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i className="ph-fill ph-users text-xl"></i></div> F√≥rum da Equipe
                            </div>
                            <div onClick={()=>setActiveRoom(isAdmin?'Caixa de Entrada':'Supervis√£o')} className={`p-4 rounded-2xl cursor-pointer font-bold flex items-center justify-between transition ${activeRoom!=='Geral'?'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md':'hover:bg-gray-100 dark:hover:bg-slate-800'}`}>
                                <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white/20 dark:bg-black/10 flex items-center justify-center"><i className="ph-fill ph-shield-star text-xl"></i></div> {isAdmin?'Caixa de Entrada':'Falar c/ Supervis√£o'}</div>
                                {/* Badge de Notifica√ß√£o Exemplo */}
                                <div className="bg-red-500 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-black shadow-lg animate-bounce">1</div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="w-2/3 flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-gray-50 dark:bg-slate-900">
                        <div className="p-6 bg-white/80 dark:bg-slate-800/80 backdrop-blur border-b border-gray-100 dark:border-slate-700 flex justify-between items-center shadow-sm z-10">
                            <h3 className="font-black text-xl">{activeRoom}</h3>
                            <button onClick={()=>onRefresh()} className="w-10 h-10 bg-gray-100 dark:bg-slate-700 rounded-full flex items-center justify-center hover:text-primary transition"><i className="ph-bold ph-arrows-clockwise"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-8 space-y-6 flex flex-col custom-scrollbar">
                            {mensagensRoom.length === 0 && <div className="m-auto text-gray-400 font-bold bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center">Nenhuma mensagem neste canal. Seja o primeiro a falar!</div>}
                            {mensagensRoom.map((m, i) => {
                                const isMe = m.Nome === myName;
                                return (
                                    <div key={i} className={`flex flex-col gap-1 max-w-[80%] ${isMe ? 'self-end items-end' : 'self-start items-start'} animate-fade-in`}>
                                        <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest mx-2">{safeString(m.Nome)}</span>
                                        <div className={`p-5 rounded-2xl shadow-md text-sm font-medium ${isMe ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-bl-none'}`}>
                                            {safeString(m.Mensagem)}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                        <form onSubmit={handleSend} className="p-5 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 flex gap-4 shrink-0 z-10">
                            <input type="text" value={msg} onChange={e=>setMsg(e.target.value)} placeholder="Escreva a sua mensagem..." className="flex-1 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full px-6 py-4 outline-none focus:ring-2 focus:ring-primary font-bold transition text-gray-800 dark:text-white" />
                            <button type="submit" className="w-14 h-14 rounded-full bg-primary text-white flex items-center justify-center shadow-lg hover:scale-105 transition transform"><i className="ph-fill ph-paper-plane-tilt text-xl"></i></button>
                        </form>
                    </div>
                </div>
            )
        };

        const MuralAvisosView = ({ data, canEdit, openModal, handleDelete }) => {
            const safeData = Array.isArray(data) ? data : [];
            const ativos = safeData.filter(item => item && typeof item === 'object' && safeString(item.Ativo).toLowerCase() !== 'n√£o' && safeString(item.Ativo).toLowerCase() !== 'nao');

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700">
                        <div>
                            <h2 className="text-2xl font-black text-gray-800 dark:text-white flex items-center gap-3"><i className="ph-fill ph-presentation-chart text-primary"></i> Mural de Avisos</h2>
                            <p className="text-sm text-gray-500 font-medium ml-9 mt-1">Quadros de avisos em destaque e comunicados oficiais.</p>
                        </div>
                        {canEdit && <button onClick={()=>openModal({})} className="bg-primary text-white px-8 py-4 rounded-full font-black shadow-lg hover:-translate-y-1 transition flex items-center gap-2"><i className="ph-bold ph-plus text-xl"></i> Criar An√∫ncio</button>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {ativos.map((item, i) => {
                            const layout = safeString(item.Layout) || 'Padr√£o';
                            if (layout === 'S√≥ Texto') {
                                return (
                                    <div key={i} className="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-custom shadow-lg p-10 card-hover flex flex-col justify-center text-white relative group overflow-hidden">
                                        <i className="ph-fill ph-megaphone absolute -right-10 -bottom-10 text-[10rem] opacity-10"></i>
                                        <h3 className="text-4xl font-black leading-tight mb-4 z-10">{safeString(item.T√≠tulo) || 'Aviso Interno'}</h3>
                                        <p className="text-xl font-medium opacity-90 z-10">{safeString(item.Subt√≠tulo)}</p>
                                        {canEdit && <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition z-20"><button onClick={()=>openModal(item)} className="w-10 h-10 bg-white/20 hover:bg-white text-white hover:text-blue-600 rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-pencil-simple text-lg"></i></button><button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="w-10 h-10 bg-white/20 hover:bg-red-500 text-white rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-trash text-lg"></i></button></div>}
                                    </div>
                                )
                            }
                            return (
                                <div key={i} className={`bg-white dark:bg-slate-800 rounded-custom shadow-lg overflow-hidden relative group border border-gray-100 dark:border-slate-700 card-hover flex flex-col ${layout==='Imagem Grande'?'h-[500px]':'h-[350px]'}`}>
                                    {item.Imagem_URL ? (
                                        <div className="absolute inset-0 w-full h-full bg-cover bg-center transition-transform duration-1000 group-hover:scale-105" style={{backgroundImage: `url('${formatImageUrl(item.Imagem_URL)}')`}}></div>
                                    ) : (
                                        <div className="absolute inset-0 w-full h-full bg-gradient-to-br from-primary to-blue-800 opacity-90"></div>
                                    )}
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent"></div>
                                    <div className="relative z-10 p-8 mt-auto">
                                        <h3 className="text-4xl font-black text-white leading-tight mb-2 drop-shadow-md">{safeString(item.T√≠tulo)}</h3>
                                        {item.Subt√≠tulo && <p className="text-xl font-bold text-gray-200 drop-shadow-md">{safeString(item.Subt√≠tulo)}</p>}
                                        {canEdit && <div className="absolute top-0 right-0 flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>openModal(item)} className="w-10 h-10 bg-white text-blue-600 rounded-xl flex items-center justify-center hover:bg-blue-600 hover:text-white transition"><i className="ph-bold ph-pencil-simple"></i></button><button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="w-10 h-10 bg-white text-red-600 rounded-xl flex items-center justify-center hover:bg-red-600 hover:text-white transition"><i className="ph-bold ph-trash"></i></button></div>}
                                    </div>
                                </div>
                            )
                        })}
                        {ativos.length === 0 && <div className="col-span-full p-20 text-center text-gray-400 font-black text-2xl border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-custom">Mural vazio.</div>}
                    </div>
                </div>
            );
        };

        const ConveniosMatrixView = ({ data, canEdit, openModal, handleDelete, schema }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            
            // Garantir as chaves de forma inquebr√°vel
            let allKeys = schema && schema.length > 0 ? schema : ['ID', 'Procedimento'];
            if (safeData.length > 0 && typeof safeData[0] === 'object' && safeData[0] !== null) {
                const dataKeys = Object.keys(safeData[0]);
                allKeys = [...new Set([...allKeys, ...dataKeys])];
            }

            let procColName = 'Procedimento';
            const specificCol = allKeys.find(k => k !== 'ID' && (safeString(k).toLowerCase().includes('procedimento') || safeString(k).toLowerCase().includes('conv√™nio') || safeString(k).toLowerCase().includes('servi√ßo')));
            if (specificCol) procColName = specificCol;
            else procColName = allKeys.find(k => k !== 'ID') || 'Procedimento';

            const insurances = allKeys.filter(k => k !== 'ID' && k !== procColName);
            const filteredData = safeData.filter(row => row && typeof row === 'object' && safeString(row[procColName]).toLowerCase().includes(search.toLowerCase()));

            const headerColors = ['#2563eb', '#0ea5e9', '#0d9488', '#10b981', '#8b5cf6', '#d946ef', '#f43f5e', '#f97316'];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700">
                        <div className="relative w-full sm:w-[400px]">
                            <i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-xl"></i>
                            <input type="text" placeholder="Buscar Servi√ßo ou Procedimento..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" />
                        </div>
                        {canEdit && (
                            <button onClick={() => {
                                let init = {}; init[procColName] = ''; insurances.forEach(ins => init[ins] = ''); openModal(init, allKeys);
                            }} className="bg-primary hover:opacity-90 text-white px-8 py-4 rounded-full font-black shadow-lg transition flex items-center gap-2"><i className="ph-bold ph-plus text-xl"></i> Adicionar Regra</button>
                        )}
                    </div>

                    <div className="bg-transparent relative overflow-hidden">
                        <div className="overflow-x-auto custom-scrollbar pb-20 pt-4 px-2">
                            <table className="matrix-table min-w-[1000px]">
                                <thead>
                                    <tr>
                                        <th>{safeString(procColName)}</th>
                                        {insurances.map((ins, i) => <th key={`head-${i}`} style={{ backgroundColor: headerColors[i % headerColors.length] }}>{safeString(ins)}</th>)}
                                        {canEdit && <th style={{ backgroundColor: '#334155' }}>A√ß√µes</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.length === 0 ? (
                                        <tr><td colSpan="100%" className="p-16 text-center text-gray-400 font-black text-xl bg-white dark:bg-slate-800 rounded-2xl shadow-sm">Matriz Vazia.</td></tr>
                                    ) : (
                                        filteredData.map((row, rowIndex) => (
                                            <tr key={`row-${rowIndex}`} className="matrix-row group">
                                                <td>{safeString(row[procColName]) || '-'}</td>
                                                {insurances.map((ins, i) => {
                                                    const val = safeString(row[ins]); const valLower = val.toLowerCase();
                                                    const isNo = valLower === 'x' || valLower === 'n√£o' || valLower === 'nao' || valLower === 'n';
                                                    const isEmpty = val === '' || val === '-';
                                                    return (
                                                        <td key={`cell-${rowIndex}-${i}`}>
                                                            {isNo ? <div className="mx-auto w-8 h-8 flex items-center justify-center rounded-full bg-red-100 text-red-600 shadow-inner" title="N√£o Cobre"><i className="ph-bold ph-x text-lg"></i></div>
                                                            : isEmpty ? <span className="text-gray-300 dark:text-slate-600 font-bold">-</span>
                                                            : <div className="flex flex-col items-center justify-center gap-1 group/tooltip relative cursor-help">
                                                                <div className="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600 shadow-inner"><i className="ph-bold ph-check text-lg"></i></div>
                                                                <span className="text-[9px] font-bold text-gray-500 bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded uppercase max-w-[100px] truncate">{val}</span>
                                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max max-w-[200px] bg-slate-900 text-white text-xs font-bold p-3 rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible z-50 whitespace-normal text-left transition-all border border-slate-700">
                                                                    <span className="block text-[10px] text-gray-400 mb-1 uppercase tracking-widest">{safeString(ins)}</span>{val}
                                                                </div>
                                                            </div>}
                                                        </td>
                                                    );
                                                })}
                                                {canEdit && (
                                                    <td className="border-l border-gray-100 dark:border-slate-700">
                                                        <div className="flex justify-center gap-2 opacity-30 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={()=>openModal(row, allKeys)} className="w-8 h-8 flex items-center justify-center bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition shadow-sm"><i className="ph-bold ph-pencil-simple"></i></button>
                                                            <button onClick={()=>{if(confirm('Excluir?')) handleDelete(row.ID)}} className="w-8 h-8 flex items-center justify-center bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm"><i className="ph-bold ph-trash"></i></button>
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const DesignInterfacePanel = ({ sheetData, onRefresh, showToast }) => {
            const configs = Array.isArray(sheetData['CONFIGURACOES']) ? sheetData['CONFIGURACOES'] : [];
            const getConfig = (chave, def) => { const item = configs.find(c => c && c.Chave === chave); return item ? item.Valor : def; };

            const [primary, setPrimary] = useState(getConfig('cor_primaria', '#1E40AF'));
            const [secondary, setSecondary] = useState(getConfig('cor_secundaria', '#F97316'));
            const [bg, setBg] = useState(getConfig('cor_fundo', '#F8FAFC'));
            const [logo, setLogo] = useState(getConfig('logo_url', ''));
            const [fontFamily, setFontFamily] = useState(getConfig('font_family', 'Inter'));
            const [borderRadius, setBorderRadius] = useState(getConfig('border_radius', '1.5rem'));
            
            const [saving, setSaving] = useState(false);

            const handleSaveDesign = async (e) => {
                e.preventDefault(); setSaving(true);
                const settingsToSave = [
                    { key: 'cor_primaria', val: primary }, { key: 'cor_secundaria', val: secondary },
                    { key: 'cor_fundo', val: bg }, { key: 'logo_url', val: logo },
                    { key: 'font_family', val: fontFamily }, { key: 'border_radius', val: borderRadius }
                ];
                for (let setting of settingsToSave) {
                    const existing = configs.find(c => c && c.Chave === setting.key);
                    await api.saveRecord('CONFIGURACOES', { 'ID': existing ? existing.ID : '', 'Chave': setting.key, 'Valor': setting.val }, !!existing);
                }
                await onRefresh('CONFIGURACOES'); setSaving(false); showToast("Design atualizado!", "success");
            };

            return (
                <div className="bg-white dark:bg-slate-800 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700 p-8 max-w-5xl mx-auto animate-fade-in">
                    <h2 className="text-3xl font-black mb-8"><i className="ph-fill ph-magic-wand text-primary"></i> Estilo do Portal</h2>
                    <form onSubmit={handleSaveDesign} className="space-y-8">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Cores</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Prim√°ria</label><input type="color" value={primary} onChange={(e) => setPrimary(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Secund√°ria</label><input type="color" value={secondary} onChange={(e) => setSecondary(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Fundo Claro</label><input type="color" value={bg} onChange={(e) => setBg(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Formatos</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Bordas</label><select className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800" value={borderRadius} onChange={e=>setBorderRadius(e.target.value)}><option value="0px">Reto</option><option value="0.5rem">Suave</option><option value="1.5rem">Moderno</option></select></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Fonte</label><select className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800" value={fontFamily} onChange={e=>setFontFamily(e.target.value)}><option value="Inter">Inter</option><option value="Roboto">Roboto</option></select></div>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Logo do Portal</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">URL (Drive ou Site)</label><input type="url" value={logo} onChange={e=>setLogo(e.target.value)} className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 text-xs font-medium" placeholder="https://..." /></div>
                            </div>
                        </div>
                        <div className="flex justify-end"><button type="submit" disabled={saving} className="bg-primary text-white font-black py-4 px-10 rounded-custom shadow-xl">{saving?'Salvando...':'Salvar Design'}</button></div>
                    </form>
                </div>
            )
        };

        const DataTableGeneric = ({ title, tabName, data, user, onRefresh, showToast }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [loading, setLoading] = useState(false);
            const [search, setSearch] = useState('');
            
            let schema = tabSchemas[tabName] || ['ID'];
            if (schema.length === 1 && safeData.length > 0 && typeof safeData[0] === 'object') {
                schema = [...new Set([...schema, ...Object.keys(safeData[0])])];
            }
            
            const nivelKey = user && typeof user === 'object' ? Object.keys(user).find(k => safeString(k).toLowerCase().includes('acesso')) : null;
            const canEdit = nivelKey && ['admin', 'supervisor', 'supervis√£o'].some(role => safeString(user[nivelKey]).toLowerCase().includes(role));

            const filteredData = safeData.filter(row => row && typeof row === 'object' && Object.values(row).some(val => safeString(val).toLowerCase().includes(search.toLowerCase())));

            const openModal = (row = null, customSchema = null) => {
                let initial = {};
                const s = customSchema || schema;
                s.forEach(col => initial[col] = row ? safeString(row[col]) : '');
                setFormData(initial); setIsModalOpen(true);
            };

            const handleSave = async (e) => {
                e.preventDefault(); setLoading(true);
                const res = await api.saveRecord(tabName, formData, !!formData.ID);
                setLoading(false);
                if (res && res.success) { setIsModalOpen(false); onRefresh(tabName); showToast('Salvo com sucesso!'); } else { showToast('Erro.', 'error') }
            };

            const handleDelete = async (id) => {
                if(confirm('Tem certeza?')) {
                    const res = await api.deleteRecord(tabName, id);
                    if (res && res.success) { onRefresh(tabName); showToast('Exclu√≠do!'); }
                }
            };

            // Roteamento Autom√°tico Inteligente
            if(tabName === 'CONV√äNIOS') return <><ConveniosMatrixView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} /> {isModalOpen && <ModalForm title="Regra" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'CORPO CLINICO') return <><CorpoClinicoCards data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} /> {isModalOpen && <ModalForm title="M√©dico" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'CONTATOS') return <><ContatosViewTabs data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} /> {isModalOpen && <ModalForm title="Contato" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'MURAL_AVISOS') return <><MuralAvisosView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} /> {isModalOpen && <ModalForm title="Aviso" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'SENHAS E LOGINS GERAIS') return <><SenhasView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} showToast={showToast} /> {isModalOpen && <ModalForm title="Acesso" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            
            // Views Split Redesenhadas (List+Detail)
            if(tabName === 'CONSULTA E PROCEDIMENTOS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Consulta/Procedimento" fieldsLeft={['C√≥digo', 'Valor Particular']} fieldsRight={['Valor Particular', 'Preparo', 'Material Utilizado']} descField="Descri√ß√£o" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Proc." schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'EXAMES LABORATORIAIS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Procedimento" fieldsLeft={['C√≥digo', 'Valor']} fieldsRight={['Valor', 'Prazo de Libera√ß√£o', 'Preparo']} descField="Motivo_Indicacao" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Lab." schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'EXAMES DE IMAGEM E OUTROS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Descri√ß√£o" fieldsLeft={['C√≥digo', 'Valor']} fieldsRight={['Valor', 'Prazo de Laudo', 'Onde Encontrar']} imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Exame/Laudo" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            
            // Views Folder Categories Redesenhadas
            if(tabName === 'EXAMES DE IMAGEM') return <><CategoryCardsView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} categoryField="Categoria" titleField="Nome do Exame" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Exame de Imagem" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'INSTITUTOS') return <><CategoryCardsView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} categoryField="Tabela_Instituto" titleField="Profissional" /> {isModalOpen && <ModalForm title="Instituto/Tabela" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;

            // Fallback Gen√©rico para o Resto
            return (
                <div className="bg-white dark:bg-slate-800 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden animate-fade-in">
                    <div className="p-8 border-b border-gray-50 dark:border-slate-700 flex justify-between items-center bg-gray-50/50 dark:bg-slate-900/50">
                        <h2 className="text-3xl font-black text-gray-900 dark:text-white">{title}</h2>
                        <div className="flex gap-4"><input type="text" placeholder="Buscar..." value={search} onChange={e=>setSearch(e.target.value)} className="px-6 py-3 bg-white dark:bg-slate-900 rounded-full font-bold outline-none" />
                        {canEdit && <button onClick={() => openModal(null, schema)} className="bg-primary text-white font-black px-8 py-3 rounded-full shadow-lg">Novo</button>}</div>
                    </div>
                    <div className="overflow-x-auto p-4">
                        <table className="w-full text-left min-w-[800px]">
                            <thead><tr className="text-gray-400 text-[10px] uppercase tracking-widest border-b dark:border-slate-700">{schema.filter(c=>safeString(c)!=='ID').map(c => <th key={c} className="p-4">{c}</th>)}<th></th></tr></thead>
                            <tbody className="text-sm font-bold">
                                {filteredData.map((row, i) => (
                                    <tr key={i} className="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/30">
                                        {schema.filter(c=>safeString(c)!=='ID').map(c => <td key={c} className="p-4">{row[c]?.includes('http')?<img src={formatImageUrl(row[c])} className="h-10 rounded-lg"/>:safeString(row[c])}</td>)}
                                        {canEdit && <td className="p-4 text-right"><button onClick={()=>openModal(row, schema)} className="text-blue-500 p-2"><i className="ph-bold ph-pencil-simple"></i></button><button onClick={()=>handleDelete(row.ID)} className="text-red-500 p-2"><i className="ph-bold ph-trash"></i></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && <ModalForm title={title} schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('Home');
            const [loading, setLoading] = useState(false);
            const [sheetData, setSheetData] = useState({});
            const [darkMode, setDarkMode] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const showToast = (msg, type = 'success') => { setToast({ show: true, message: msg, type }); setTimeout(() => setToast(p => ({ ...p, show: false })), 3500); };

            useEffect(() => {
                const init = async () => {
                    if(!isFirebaseConfigured) return;
                    const allData = await api.fetchAll(); 
                    if(allData && Object.keys(allData).length > 0) {
                        setSheetData(allData);
                        const conf = allData['CONFIGURACOES'] || [];
                        conf.forEach(c => {
                            if(c.Chave === 'cor_primaria') document.documentElement.style.setProperty('--color-primary', c.Valor);
                            if(c.Chave === 'cor_secundaria') document.documentElement.style.setProperty('--color-secondary', c.Valor);
                            if(c.Chave === 'cor_fundo') document.documentElement.style.setProperty('--color-bg', c.Valor);
                        });
                    }
                }; init();
            }, []);

            const loadData = async (tab) => {
                setLoading(true);
                if (tab === 'Home') {
                    const [news, atend, lembretes, mural] = await Promise.all([api.fetch('NOVIDADES_E_EVENTOS'), api.fetch('CONTROLE_ATENDIMENTOS'), api.fetch('LEMBRETES_HORA'), api.fetch('MURAL_AVISOS')]);
                    setSheetData(prev => ({ ...prev, 'NOVIDADES_E_EVENTOS': news, 'CONTROLE_ATENDIMENTOS': atend, 'LEMBRETES_HORA': lembretes, 'MURAL_AVISOS': mural }));
                } else if (tab === 'ESCALAS') {
                    const [escala, medicos, u] = await Promise.all([api.fetch('ESCALAS'), api.fetch('CORPO CLINICO'), api.fetch('USUARIOS')]);
                    setSheetData(prev => ({ ...prev, 'ESCALAS': escala, 'CORPO CLINICO': medicos, 'USUARIOS': u }));
                } else {
                    const data = await api.fetch(tab); setSheetData(prev => ({ ...prev, [tab]: data }));
                }
                setLoading(false);
            };

            if (!user) {
                const handleLogin = async (e) => {
                    e.preventDefault(); setLoading(true);
                    const res = await api.login(e.target.email.value, e.target.password.value);
                    if (res && res.success) { setUser(res.user); loadData('Home'); } else alert(res?.message);
                    setLoading(false);
                };
                return (
                    <div className="min-h-screen bg-medical dark:bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
                            <div className="p-12 bg-gradient-to-br from-primary to-blue-800 text-white text-center">
                                <div className="w-28 h-28 mx-auto bg-white/10 rounded-[2rem] flex items-center justify-center mb-6"><i className="ph-fill ph-heartbeat text-7xl"></i></div>
                                <h1 className="text-4xl font-black">S√£o Vicente</h1>
                            </div>
                            <form onSubmit={handleLogin} className="p-10 space-y-6">
                                <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase">E-mail</label><input name="email" type="text" className="w-full p-4 bg-gray-50 border rounded-custom outline-none font-bold" required /></div>
                                <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase">Senha</label><input name="password" type="password" className="w-full p-4 bg-gray-50 border rounded-custom outline-none font-bold" required /></div>
                                <button type="submit" className="w-full bg-secondary text-white font-black py-5 rounded-custom shadow-xl">{loading ? 'A carregar...' : 'Acessar'}</button>
                            </form>
                        </div>
                    </div>
                );
            }

            const menus = [
                { id: 'Home', icon: 'ph-house', label: 'Dashboard Inicial' },
                { id: 'MURAL_AVISOS', icon: 'ph-presentation-chart', label: 'Mural de Avisos' },
                { id: 'ESCALAS', icon: 'ph-calendar-check', label: 'Escalas e Plant√µes' },
                { id: 'CONV√äNIOS', icon: 'ph-file-text', label: 'Matriz de Conv√™nios' },
                { id: 'CORPO CLINICO', icon: 'ph-stethoscope', label: 'Corpo Cl√≠nico' },
                { id: 'CONTATOS', icon: 'ph-address-book', label: 'Contatos R√°pidos' },
                { id: 'CHAT_MENSAGENS', icon: 'ph-chat-circle-dots', label: 'Chat Interno' },
                { id: 'EXAMES DE IMAGEM', icon: 'ph-bone', label: 'Exames de Imagem' },
                { id: 'EXAMES DE IMAGEM E OUTROS', icon: 'ph-files', label: 'Exames e Laudos' },
                { id: 'CONSULTA E PROCEDIMENTOS', icon: 'ph-first-aid-kit', label: 'Consultas' },
                { id: 'EXAMES LABORATORIAIS', icon: 'ph-flask', label: 'Laborat√≥rio' },
                { id: 'INSTITUTOS', icon: 'ph-buildings', label: 'Institutos' },
                { id: 'REMO√á√ïES', icon: 'ph-car', label: 'Remo√ß√µes' },
                { id: 'SENHAS E LOGINS GERAIS', icon: 'ph-lock-key', label: 'Senhas de Sistemas' }
            ];
            const adminMenus = [ { id: 'CONTROLE_ATENDIMENTOS', icon: 'ph-chart-line-up', label: 'Limites Unimed' }, { id: 'USUARIOS', icon: 'ph-users', label: 'Colaboradores' }, { id: 'DESIGN_INTERFACE', icon: 'ph-magic-wand', label: 'Design de Interface' }, { id: 'LEMBRETES_HORA', icon: 'ph-clock', label: 'Avisos do Rel√≥gio' } ];

            return (
                <div className="min-h-screen flex flex-col md:flex-row overflow-hidden relative selection:bg-primary selection:text-white">
                    {toast.show && <div className="fixed bottom-8 right-8 z-[9999] px-8 py-5 rounded-custom shadow-2xl text-white font-black text-lg animate-slide-up bg-green-500"><i className="ph-bold ph-check-circle text-2xl"></i> {toast.message}</div>}

                    <aside className="w-80 bg-white dark:bg-slate-800 border-r border-gray-100 dark:border-slate-700 flex flex-col h-screen shrink-0 shadow-2xl z-30">
                        <div className="p-8 flex items-center border-b bg-gray-50/50 cursor-pointer" onClick={()=>{setActiveTab('Home'); loadData('Home');}}>
                            <div className="bg-primary text-white p-3 rounded-2xl mr-3"><i className="ph-fill ph-heartbeat text-3xl"></i></div>
                            <div><h1 className="text-2xl font-black leading-none">Portal</h1><span className="text-[10px] font-black text-primary uppercase">S√£o Vicente</span></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar pb-8">
                            <div className="px-4 mb-2 mt-2 text-[10px] font-black text-gray-400 uppercase">Menu</div>
                            {menus.map(m => <button key={m.id} onClick={()=>{setActiveTab(m.id); loadData(m.id);}} className={`w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold transition-all ${activeTab===m.id?'bg-primary text-white shadow-xl scale-[1.02]':'text-gray-500 hover:bg-gray-100'}`}><i className={`ph-fill ${m.icon} text-xl`}></i> {m.label}</button>)}
                            
                            {user?.['N√≠vel de Acesso']?.toLowerCase() === 'admin' && (
                                <>
                                    <div className="px-4 mt-6 mb-2 text-[10px] font-black text-gray-400 uppercase">Admin</div>
                                    {adminMenus.map(m => <button key={m.id} onClick={()=>{setActiveTab(m.id); loadData(m.id);}} className={`w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold transition-all ${activeTab===m.id?'bg-gray-900 text-white shadow-xl scale-[1.02]':'text-gray-500 hover:bg-gray-100'}`}><i className={`ph-fill ${m.icon} text-xl`}></i> {m.label}</button>)}
                                </>
                            )}
                            <button onClick={()=>setUser(null)} className="w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold text-red-600 hover:bg-red-50 mt-8"><i className="ph-fill ph-sign-out text-xl"></i> Sair</button>
                        </div>
                    </aside>

                    <main className="flex-1 h-screen overflow-y-auto relative custom-scrollbar p-6 md:p-10">
                        <ErrorBoundary>
                            {loading && <div className="fixed inset-0 bg-white/70 backdrop-blur z-50 flex items-center justify-center"><div className="animate-spin h-12 w-12 border-4 border-t-primary rounded-full"></div></div>}

                            {activeTab === 'Home' && !loading && (
                                <div className="space-y-12 animate-fade-in max-w-[1400px] mx-auto">
                                    <ClockWidget lembretesData={sheetData['LEMBRETES_HORA']} />
                                    
                                    {/* Alertas Unimed */}
                                    {Array.isArray(sheetData['CONTROLE_ATENDIMENTOS']) && sheetData['CONTROLE_ATENDIMENTOS'].filter(a => Number(a.Limite_Max||0) > 0 && (Number(a.Qtd_Atual||0)/Number(a.Limite_Max||1)) >= 0.9).length > 0 && (
                                        <div>
                                            <h3 className="text-2xl font-black text-red-600 flex items-center gap-3 mb-6"><i className="ph-fill ph-warning-circle animate-pulse"></i> Alertas Unimed</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                {sheetData['CONTROLE_ATENDIMENTOS'].filter(a => Number(a.Limite_Max||0) > 0 && (Number(a.Qtd_Atual||0)/Number(a.Limite_Max||1)) >= 0.9).map((a, i) => {
                                                    const qtd = Number(a.Qtd_Atual || 0); const max = Number(a.Limite_Max || 1);
                                                    const perc = (qtd / max) * 100; const isCritico = perc >= 100;
                                                    return (
                                                        <div key={i} className={`p-8 rounded-[2.5rem] shadow-xl border-4 ${isCritico ? 'bg-red-600 border-red-800 text-white' : 'bg-orange-50 border-orange-200 text-orange-900'}`}>
                                                            <div className="flex justify-between items-center mb-6"><span className="font-black text-2xl">{safeString(a.Profissional)}</span></div>
                                                            <div className="w-full bg-black/10 rounded-full h-4 mb-4"><div className={`h-4 rounded-full ${isCritico ? 'bg-white' : 'bg-orange-500'}`} style={{width: `${Math.min(perc, 100)}%`}}></div></div>
                                                            <p className="text-5xl font-black leading-none">{qtd} <span className="text-xl opacity-60">/ {max}</span></p>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    <div>
                                        <h3 className="text-3xl font-black mb-8">Acesso R√°pido</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-6 gap-6">
                                            {[ { l: 'Mural', i: 'ph-presentation-chart', bg:'bg-blue-50', c:'text-blue-600', t: 'MURAL_AVISOS' }, { l: 'Imagem', i: 'ph-bone', bg:'bg-green-50', c:'text-green-600', t: 'EXAMES DE IMAGEM' }, { l: 'Consultas', i: 'ph-stethoscope', bg:'bg-blue-50', c:'text-blue-600', t: 'CONSULTA E PROCEDIMENTOS' }, { l: 'Lab', i: 'ph-flask', bg:'bg-purple-50', c:'text-purple-600', t: 'EXAMES LABORATORIAIS' }, { l: 'Institutos', i: 'ph-buildings', bg:'bg-orange-50', c:'text-orange-600', t: 'INSTITUTOS' }, { l: 'Remo√ß√µes', i: 'ph-car', bg:'bg-yellow-50', c:'text-yellow-600', t: 'REMO√á√ïES' } ].map((d, i) => (
                                                <button key={i} onClick={()=>{setActiveTab(d.t);loadData(d.t)}} className={`${d.bg} ${d.c} p-6 rounded-[2rem] flex flex-col items-center gap-4 card-hover shadow-sm`}>
                                                    <i className={`ph-fill ${d.i} text-4xl`}></i><span className="font-black text-sm uppercase tracking-widest">{d.l}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'CHAT_MENSAGENS' && !loading && <ChatModerno chatData={sheetData['CHAT_MENSAGENS']} user={user} onSaveChat={api.saveRecord} onRefresh={()=>loadData('CHAT_MENSAGENS')} />}
                            {activeTab === 'ESCALAS' && !loading && <EscalasContainer sheetData={sheetData} user={user} onRefresh={()=>loadData('ESCALAS')} showToast={showToast} />}
                            {activeTab === 'DESIGN_INTERFACE' && !loading && <DesignInterfacePanel sheetData={sheetData} onRefresh={()=>loadData('CONFIGURACOES')} showToast={showToast} />}

                            {activeTab !== 'Home' && activeTab !== 'CHAT_MENSAGENS' && activeTab !== 'ESCALAS' && activeTab !== 'DESIGN_INTERFACE' && !loading && (
                                <DataTableGeneric title={menus.concat(adminMenus).find(m=>m.id===activeTab)?.label} tabName={activeTab} data={sheetData[activeTab] || []} user={user} onRefresh={()=>loadData(activeTab)} showToast={showToast} />
                            )}
                        </ErrorBoundary>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
