<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ========================================== -->
    <!-- BLINDAGEM ANTI-CACHE (FOR√áA O NAVEGADOR A ATUALIZAR) -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        const VERSAO_ATUAL = "4.0.0"; // Cache buster atualizado
        if (window.location.search.indexOf('v=' + VERSAO_ATUAL) === -1) {
            localStorage.clear();
            sessionStorage.clear();
            window.location.replace(window.location.pathname + (window.location.pathname.indexOf('?') === -1 ? '?' : '&') + 'v=' + VERSAO_ATUAL);
        }
    </script>
    <!-- ========================================== -->

    <title>Portal S√£o Vicente</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: { primary: 'var(--color-primary, #1E40AF)', secondary: 'var(--color-secondary, #F97316)', medical: 'var(--color-medical, #E0F2FE)' },
                    fontFamily: { sans: ['var(--font-family, Inter)', 'sans-serif'] },
                    borderRadius: { 'custom': 'var(--border-radius, 1.5rem)' },
                    animation: { 
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 
                        'fade-in': 'fadeIn 0.4s ease-out', 
                        'pop-in': 'popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'ticker': 'ticker 25s linear infinite',
                        'spin-slow': 'spin 8s linear infinite'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(100%)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        ticker: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Roboto:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Scripts do React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel para traduzir o React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE SDK (V8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --color-primary: #1E40AF; --color-secondary: #F97316; --color-medical: #E0F2FE; --color-bg: #F8FAFC; --font-family: 'Inter'; --border-radius: 1.5rem; --card-transition: all 0.3s ease; }
        body { font-family: var(--font-family), sans-serif; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; background-color: var(--color-bg); }
        body.dark { background-color: #0f172a; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .card-hover { transition: var(--card-transition); border-radius: var(--border-radius); }
        .card-hover:hover { transform: translateY(-5px) scale(1.02); z-index: 10; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .glass-modal { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); }
        .dark .glass-modal { background: rgba(15, 23, 42, 0.85); }
        .ticker-container { display: flex; overflow: hidden; white-space: nowrap; width: 100%; align-items: center; }
        .rounded-custom { border-radius: var(--border-radius) !important; }

        /* Tabela de Matriz Premium */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        .matrix-table th { padding: 1.5rem 1rem; color: white; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; text-align: center; border: none; }
        .matrix-table th:first-child { border-radius: 1rem 0 0 1rem; background-color: #1e293b; text-align: left; position: sticky; left: 0; z-index: 30; }
        .matrix-table th:last-child { border-radius: 0 1rem 1rem 0; }
        .matrix-row { background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .matrix-row:hover { transform: translateY(-3px); box-shadow: 0 15px 25px -5px rgba(0,0,0,0.1); z-index: 20; }
        .dark .matrix-row { background-color: #1e293b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .matrix-row td { padding: 1rem; text-align: center; vertical-align: middle; border: none; }
        .matrix-row td:first-child { background-color: #1e293b; color: white; font-weight: bold; border-radius: 1rem 0 0 1rem; text-align: left; position: sticky; left: 0; z-index: 20; border-left: 6px solid var(--color-primary); }
        .matrix-row td:last-child { border-radius: 0 1rem 1rem 0; }
    </style>
</head>
<body class="text-gray-800 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef, Component } = React;
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // ==========================================
        // üõë SUAS CHAVES DO FIREBASE AQUI üõë
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyArUJk5o90YfmMqRZl2kBaFfvRXFZcW3cE",
            authDomain: "portal-sao-vicente.firebaseapp.com",
            projectId: "portal-sao-vicente",
            storageBucket: "portal-sao-vicente.firebasestorage.app",
            messagingSenderId: "52988900084",
            appId: "1:52988900084:web:9f5f2d494c22b10eb2a4a1"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey !== "" && firebaseConfig.apiKey !== "COLE_AQUI" && !firebaseConfig.apiKey.includes("AIzaSySuaChave");
        
        let db = null;
        let auth = null;

        if (isFirebaseConfigured) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
            } catch (error) {
                console.error("Erro cr√≠tico ao inicializar Firebase:", error);
            }
        }

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, errorInfo: null }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Escudo ativado:", error); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center p-6 w-full">
                            <div className="bg-white dark:bg-slate-800 p-10 rounded-[2rem] shadow-2xl text-center max-w-xl border border-red-200">
                                <div className="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6"><i className="ph-fill ph-warning-circle text-6xl"></i></div>
                                <h2 className="text-2xl font-black mb-4">M√≥dulo Indispon√≠vel</h2>
                                <p className="text-gray-500 mb-8">Ocorreu um erro ao renderizar este bloco. Tente limpar o cache do navegador (Ctrl+F5).</p>
                                <button onClick={() => { this.setState({ hasError: false }); window.location.reload(); }} className="w-full bg-red-600 text-white py-4 rounded-xl font-black shadow-lg">Tentar Novamente</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const safeString = (val) => (val === null || val === undefined) ? '' : String(val);

        const formatImageUrl = (url) => {
            const strUrl = safeString(url).trim();
            if (!strUrl) return '';
            if (strUrl.includes('drive.google.com')) {
                const match = strUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || strUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
            }
            return strUrl;
        };

        const tabSchemas = {
            'CORPO CLINICO': ['ID', 'M√©dico', 'Especialidade', 'Segmento', 'C√≥digo UNIMED', 'CRM', 'Cor_Selo', 'Foto_URL'],
            'EXAMES DE IMAGEM': ['ID', 'Categoria', 'C√≥digo', 'Nome do Exame', 'Profissionais', 'Idade Permitida', 'Observa√ß√µes', 'Imagem_URL'],
            'EXAMES DE IMAGEM E OUTROS': ['ID', 'C√≥digo', 'Descri√ß√£o', 'Valor', 'Prazo de Laudo', 'Onde Encontrar', 'Imagem_URL'],
            'CONSULTA E PROCEDIMENTOS': ['ID', 'C√≥digo', 'Consulta/Procedimento', 'Descri√ß√£o', 'Preparo', 'Material Utilizado', 'Valor Particular', 'Imagem_URL'],
            'EXAMES LABORATORIAIS': ['ID', 'C√≥digo', 'Procedimento', 'Valor', 'Prazo de Libera√ß√£o', 'Preparo', 'Motivo_Indicacao'],
            'CONTATOS': ['ID', 'Tipo', 'Local_Setor', 'Nome_Contato', 'Valor_Contato', 'Anotacoes'], 
            'SENHAS E LOGINS GERAIS': ['ID', 'Nome do Sistema', 'Link do Sistema', 'Login', 'Senha', 'Observa√ß√µes'],
            'REMO√á√ïES': ['ID', 'Nome do Hospital/Cl√≠nica', 'Contato', 'Local', 'Informa√ß√µes Importantes', 'Conv√™nios Atendidos', 'Imagem_URL'],
            'INSTITUTOS': ['ID', 'Tabela_Instituto', 'Profissional', 'Especialidade', 'CRM_URA', 'Valores'],
            'NOVIDADES_E_EVENTOS': ['ID', 'Tipo', 'T√≠tulo', 'Mensagem', 'Data de Publica√ß√£o', 'Imagem_URL'],
            'CONTROLE_ATENDIMENTOS': ['ID', 'Profissional', 'Conv√™nio', 'Qtd_Atual', 'Limite_Max'],
            'USUARIOS': ['ID', 'Nome Completo', 'E-mail', 'Senha', 'N√≠vel de Acesso', 'Data de Nascimento', 'Foto_Perfil_URL', 'Status'],
            'ESCALAS': ['ID', 'Tipo_Profissional', 'Nome_Profissional', 'Data', 'Turno', 'Horario', 'Unidade', 'Setor_Consultorio', 'Status', 'Tipo_Atendimento'],
            'CHAT_MENSAGENS': ['ID', 'Data_Hora', 'Nome', 'Mensagem', 'Destinatario'],
            'LEMBRETES_HORA': ['ID', 'Hora', 'Mensagem'],
            'CONFIGURACOES': ['ID', 'Chave', 'Valor'],
            'MURAL_AVISOS': ['ID', 'Layout', 'T√≠tulo', 'Subt√≠tulo', 'Imagem_URL', 'Link', 'Ativo']
        };

        const api = {
            fetch: async (colName) => {
                if(!db) return [];
                try {
                    const snap = await db.collection(colName).get();
                    return snap.docs.map(doc => ({ ID: doc.id, ...doc.data() }));
                } catch (e) { return []; }
            },
            fetchAll: async () => {
                if(!db) return {};
                let allData = {};
                for (let c of Object.keys(tabSchemas)) {
                    try {
                        const snap = await db.collection(c).get();
                        allData[c] = snap.docs.map(doc => ({ ID: doc.id, ...doc.data() }));
                    } catch(e) {}
                }
                return allData;
            },
            login: async (rawEmail, password) => {
                if(!isFirebaseConfigured || !auth) return { success: false, message: 'As chaves do Firebase n√£o est√£o configuradas corretamente na Linha 80 do arquivo.' };
                try {
                    // LIMPEZA DE ESPA√áOS NO E-MAIL (MUITO IMPORTANTE PARA EVITAR ERROS)
                    const email = rawEmail.trim(); 
                    
                    await auth.signInWithEmailAndPassword(email, password);
                    const userDoc = await db.collection('USUARIOS').where('E-mail', '==', email).get();
                    let userData = { 'E-mail': email, 'Nome Completo': email.split('@')[0], 'N√≠vel de Acesso': 'Admin' };
                    if (!userDoc.empty) {
                        userData = { ID: userDoc.docs[0].id, ...userDoc.docs[0].data() };
                        if (userData.Status && String(userData.Status).toLowerCase() !== 'ativo') {
                            await auth.signOut(); return { success: false, message: 'Sua conta de funcion√°rio est√° inativa no painel.' };
                        }
                    }
                    return { success: true, user: userData };
                } catch (error) { 
                    console.error("Erro de Autentica√ß√£o:", error);
                    let msg = "E-mail ou senha incorretos.";
                    
                    if (error.code === 'auth/user-not-found') msg = "Este e-mail n√£o existe no Firebase. Lembre-se de criar o usu√°rio na aba 'Authentication' -> 'Users'.";
                    if (error.code === 'auth/wrong-password') msg = "A senha digitada est√° incorreta. Verifique se o Caps Lock est√° ativado.";
                    if (error.code === 'auth/invalid-email') msg = "O formato do e-mail √© inv√°lido. Verifique erros de digita√ß√£o.";
                    if (error.code === 'auth/invalid-credential') msg = "E-mail ou Senha incorretos. A senha deve ser exatamente a cadastrada na aba 'Authentication' do Firebase.";
                    if (error.code === 'auth/operation-not-allowed') msg = "Voc√™ n√£o ativou a op√ß√£o de 'E-mail/Senha' no Firebase (na aba Sign-in method)!";
                    
                    return { success: false, message: msg }; 
                }
            },
            saveRecord: async (colName, data, isEdit) => {
                if(!db) return { success: false };
                try {
                    let docData = { ...data };
                    // Limpa espa√ßos vazios apenas nas extremidades (trim), permitindo espa√ßos normais no meio das palavras
                    Object.keys(docData).forEach(k => { if(typeof docData[k] === 'string') docData[k] = docData[k].trim(); });
                    let id = docData.ID; delete docData.ID;
                    Object.keys(docData).forEach(key => docData[key] === undefined && delete docData[key]);

                    if (isEdit && id) await db.collection(colName).doc(id).update(docData);
                    else await db.collection(colName).add(docData);
                    return { success: true };
                } catch (e) { return { success: false }; }
            },
            deleteRecord: async (colName, id) => {
                if(!db) return { success: false };
                try { await db.collection(colName).doc(id).delete(); return { success: true }; } 
                catch (e) { return { success: false }; }
            }
        };

        const ClockWidget = ({ lembretesData }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            
            const hour = time.getHours();
            let periodStr = 'Bom dia'; let icon = 'ph-sun'; let bgClass = 'bg-blue-50 border-blue-200 text-blue-800 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-200';
            
            if (hour >= 12 && hour < 18) { periodStr = 'Boa tarde'; icon = 'ph-cloud-sun'; bgClass = 'bg-orange-50 border-orange-200 text-orange-800 dark:bg-orange-900/30 dark:border-orange-800 dark:text-orange-200'; }
            else if (hour >= 18 || hour < 6) { periodStr = 'Boa noite'; icon = 'ph-moon-stars'; bgClass = 'bg-indigo-900 border-indigo-700 text-indigo-100 dark:bg-slate-800 dark:border-slate-700 dark:text-indigo-200'; }

            const lembretes = Array.isArray(lembretesData) ? lembretesData : [];
            const lembreteAtual = lembretes.find(l => l && typeof l === 'object' && parseInt(safeString(l.Hora) || -1) === hour);
            const msg = lembreteAtual ? safeString(lembreteAtual.Mensagem) : 'Tenha um excelente turno de trabalho!';

            return (
                <div className={`p-6 rounded-custom border-2 shadow-sm flex items-center justify-between transition-colors duration-1000 ${bgClass}`}>
                    <div className="flex items-center gap-5">
                        <div className="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center shadow-inner">
                            <i className={`ph-fill ${icon} text-4xl animate-spin-slow`}></i>
                        </div>
                        <div>
                            <h2 className="text-4xl font-black tracking-tighter">{time.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</h2>
                            <p className="text-sm font-bold uppercase tracking-widest opacity-80 mt-1">{periodStr}</p>
                        </div>
                    </div>
                    <div className="hidden md:flex flex-col items-end max-w-xs text-right border-l-2 border-white/20 pl-6">
                        <span className="text-[10px] font-black uppercase tracking-widest opacity-60 mb-1 flex items-center gap-1"><i className="ph-fill ph-bell-ringing animate-pulse"></i> Lembrete da Hora</span>
                        <p className="text-base font-bold leading-tight">{msg}</p>
                    </div>
                </div>
            )
        };

        const ModalForm = ({ title, schema, formData, setFormData, onSave, onClose, loading }) => {
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 glass-modal animate-fade-in" onMouseDown={onClose}>
                    <div className="bg-white dark:bg-slate-800 rounded-custom w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl animate-pop-in overflow-hidden border border-gray-100 dark:border-slate-700" onMouseDown={e => e.stopPropagation()}>
                        <div className="p-6 bg-gray-50 dark:bg-slate-900 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center shrink-0">
                            <h3 className="text-2xl font-black flex items-center gap-3 text-gray-900 dark:text-white"><div className="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center"><i className={`ph-bold ${formData?.ID ? 'ph-pencil-simple' : 'ph-plus'}`}></i></div> {formData?.ID ? 'Editar' : 'Novo'} {title}</h3>
                            <button type="button" onClick={onClose} className="w-10 h-10 rounded-full bg-gray-200 dark:bg-slate-700 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i className="ph-bold ph-x text-lg"></i></button>
                        </div>
                        <div className="p-8 overflow-y-auto flex-1 custom-scrollbar">
                            <form id="gen-form" onSubmit={onSave} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {(schema || []).filter(col => safeString(col) !== 'ID').map((col, idx) => {
                                    const colName = safeString(col);
                                    const cLower = colName.toLowerCase();
                                    const isLong = cLower.includes('descri√ß√£o') || cLower.includes('anota√ß√µes') || cLower.includes('mensagem') || cLower.includes('preparo') || cLower.includes('url') || cLower.includes('site') || cLower.includes('motivo');
                                    
                                    return (
                                        <div key={idx} className={isLong ? 'md:col-span-2' : ''}>
                                            <label className="block text-xs font-black text-gray-400 dark:text-slate-400 mb-2 uppercase tracking-widest">{colName}</label>
                                            
                                            {colName === 'Layout' && title.includes('Aviso') ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="Padr√£o">Padr√£o</option><option value="Imagem Grande">Imagem Grande (Banner)</option><option value="S√≥ Texto">S√≥ Texto</option>
                                                </select>
                                            ) : colName === 'Tipo' && title.includes('Contato') ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="Ramal">Ramal Interno</option><option value="Email">E-mail</option><option value="Telefone">Telefone Externo</option>
                                                </select>
                                            ) : colName.includes('?') || colName === 'Status' || colName === 'Ativo' ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="">Selecione...</option><option value="Sim">Sim</option><option value="N√£o">N√£o</option><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option>
                                                </select>
                                            ) : colName === 'N√≠vel de Acesso' ? (
                                                <select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})}>
                                                    <option value="">Selecione...</option><option value="Colaborador">Colaborador</option><option value="Supervisor">Supervisor</option><option value="Admin">Admin</option>
                                                </select>
                                            ) : colName.includes('Cor') ? (
                                                <div className="flex items-center gap-3 bg-gray-50 dark:bg-slate-900 p-3 rounded-custom border border-gray-200 dark:border-slate-700">
                                                    <input type="color" className="w-10 h-10 rounded-xl cursor-pointer border-0 bg-transparent" value={safeString(formData[colName]) || '#1E40AF'} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} />
                                                    <span className="font-mono text-sm font-bold text-gray-500">{safeString(formData[colName]) || 'Cor Padr√£o'}</span>
                                                </div>
                                            ) : isLong && !cLower.includes('url') && !cLower.includes('site') ? (
                                                <textarea className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary min-h-[120px] font-medium text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} placeholder={`Detalhes...`}></textarea>
                                            ) : (
                                                <input type={cLower.includes('senha') ? 'text' : 'text'} className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" value={safeString(formData[colName])} onChange={(e) => setFormData({...formData, [colName]: e.target.value})} placeholder={`Preencha ${cLower}`} />
                                            )}
                                        </div>
                                    )
                                })}
                            </form>
                        </div>
                        <div className="p-6 border-t border-gray-100 dark:border-slate-700 flex justify-end gap-3 bg-white dark:bg-slate-800 shrink-0">
                            <button type="button" onClick={onClose} className="font-bold text-gray-500 px-8 py-4 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-custom transition">Cancelar</button>
                            <button type="submit" form="gen-form" disabled={loading} className="bg-primary hover:opacity-90 text-white font-black px-10 py-4 rounded-custom shadow-xl shadow-primary/30 transition transform hover:-translate-y-1 flex items-center gap-2">
                                {loading ? <i className="ph animate-spin ph-spinner text-xl"></i> : <i className="ph-bold ph-floppy-disk text-xl"></i>} {loading ? 'Salvando...' : 'Salvar'}
                            </button>
                        </div>
                    </div>
                </div>
            )
        };

        const MuralAvisosView = ({ data, canEdit, openModal, handleDelete }) => {
            const safeData = Array.isArray(data) ? data : [];
            const ativos = safeData.filter(item => item && typeof item === 'object' && safeString(item.Ativo).toLowerCase() !== 'n√£o' && safeString(item.Ativo).toLowerCase() !== 'nao');

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700">
                        <div>
                            <h2 className="text-2xl font-black text-gray-800 dark:text-white flex items-center gap-3"><i className="ph-fill ph-presentation-chart text-primary"></i> Mural de Avisos</h2>
                            <p className="text-sm text-gray-500 font-medium ml-9 mt-1">Quadros de avisos em destaque e comunicados oficiais.</p>
                        </div>
                        {canEdit && <button onClick={()=>openModal({Layout: 'Padr√£o'})} className="bg-primary text-white px-8 py-4 rounded-full font-black shadow-lg hover:-translate-y-1 transition flex items-center gap-2"><i className="ph-bold ph-plus text-xl"></i> Criar An√∫ncio</button>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {ativos.map((item, i) => {
                            const layout = safeString(item.Layout) || 'Padr√£o';
                            if (layout === 'S√≥ Texto') {
                                return (
                                    <div key={i} className="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-custom shadow-lg p-10 card-hover flex flex-col justify-center text-white relative group overflow-hidden h-[350px]">
                                        <i className="ph-fill ph-megaphone absolute -right-10 -bottom-10 text-[10rem] opacity-10"></i>
                                        <h3 className="text-4xl font-black leading-tight mb-4 z-10">{safeString(item.T√≠tulo) || 'Aviso Interno'}</h3>
                                        <p className="text-xl font-medium opacity-90 z-10">{safeString(item.Subt√≠tulo)}</p>
                                        {canEdit && <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition z-20"><button onClick={()=>openModal(item)} className="w-10 h-10 bg-white/20 hover:bg-white text-white hover:text-blue-600 rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-pencil-simple text-lg"></i></button><button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="w-10 h-10 bg-white/20 hover:bg-red-500 text-white rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-trash text-lg"></i></button></div>}
                                    </div>
                                )
                            }
                            return (
                                <div key={i} className={`bg-white dark:bg-slate-800 rounded-custom shadow-lg overflow-hidden relative group border border-gray-100 dark:border-slate-700 card-hover flex flex-col ${layout==='Imagem Grande'?'h-[500px]':'h-[350px]'}`}>
                                    {item.Imagem_URL ? (
                                        <div className="absolute inset-0 w-full h-full bg-cover bg-center transition-transform duration-1000 group-hover:scale-105" style={{backgroundImage: `url('${formatImageUrl(item.Imagem_URL)}')`}}></div>
                                    ) : (
                                        <div className="absolute inset-0 w-full h-full bg-gradient-to-br from-primary to-blue-800 opacity-90"></div>
                                    )}
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent"></div>
                                    <div className="relative z-10 p-8 mt-auto">
                                        <h3 className="text-4xl font-black text-white leading-tight mb-2 drop-shadow-md">{safeString(item.T√≠tulo)}</h3>
                                        {item.Subt√≠tulo && <p className="text-xl font-bold text-gray-200 drop-shadow-md">{safeString(item.Subt√≠tulo)}</p>}
                                        {item.Link && <a href={safeString(item.Link)} target="_blank" className="mt-4 inline-block bg-white text-gray-900 font-black px-6 py-3 rounded-xl shadow-lg hover:bg-gray-100 transition">Acessar Link</a>}
                                        {canEdit && <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>openModal(item)} className="w-10 h-10 bg-white/20 hover:bg-white text-white hover:text-blue-600 rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-pencil-simple text-lg"></i></button><button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="w-10 h-10 bg-white/20 hover:bg-red-500 text-white rounded-xl flex items-center justify-center transition"><i className="ph-bold ph-trash text-lg"></i></button></div>}
                                    </div>
                                </div>
                            )
                        })}
                        {ativos.length === 0 && <div className="col-span-full p-20 text-center text-gray-400 font-black text-2xl border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-custom">Mural vazio.</div>}
                    </div>
                </div>
            );
        };

        const ConveniosMatrixView = ({ data, canEdit, openModal, handleDelete, schema }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            
            let allKeys = schema && schema.length > 0 ? schema : ['ID', 'Procedimento'];
            if (safeData.length > 0 && typeof safeData[0] === 'object' && safeData[0] !== null) {
                const dataKeys = Object.keys(safeData[0]);
                allKeys = [...new Set([...allKeys, ...dataKeys])];
            }

            let procColName = 'Procedimento';
            const specificCol = allKeys.find(k => k !== 'ID' && (safeString(k).toLowerCase().includes('procedimento') || safeString(k).toLowerCase().includes('conv√™nio') || safeString(k).toLowerCase().includes('servi√ßo')));
            if (specificCol) procColName = specificCol;
            else procColName = allKeys.find(k => k !== 'ID') || 'Procedimento';

            const insurances = allKeys.filter(k => k !== 'ID' && k !== procColName);
            const filteredData = safeData.filter(row => row && typeof row === 'object' && safeString(row[procColName]).toLowerCase().includes(search.toLowerCase()));

            const headerColors = ['#2563eb', '#0ea5e9', '#0d9488', '#10b981', '#8b5cf6', '#d946ef', '#f43f5e', '#f97316'];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700">
                        <div className="relative w-full sm:w-[400px]">
                            <i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-xl"></i>
                            <input type="text" placeholder="Buscar Servi√ßo..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold text-gray-800 dark:text-white" />
                        </div>
                        {canEdit && (
                            <button onClick={() => { let init = {}; init[procColName] = ''; insurances.forEach(ins => init[ins] = ''); openModal(init, allKeys); }} className="bg-primary hover:opacity-90 text-white px-8 py-4 rounded-full font-black shadow-lg transition flex items-center gap-2"><i className="ph-bold ph-plus text-xl"></i> Adicionar Regra</button>
                        )}
                    </div>

                    <div className="bg-transparent relative overflow-hidden">
                        <div className="overflow-x-auto custom-scrollbar pb-20 pt-4 px-2">
                            <table className="matrix-table min-w-[1000px]">
                                <thead>
                                    <tr>
                                        <th>{safeString(procColName)}</th>
                                        {insurances.map((ins, i) => <th key={`head-${i}`} style={{ backgroundColor: headerColors[i % headerColors.length] }}>{safeString(ins)}</th>)}
                                        {canEdit && <th style={{ backgroundColor: '#334155' }}>A√ß√µes</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredData.length === 0 ? (
                                        <tr><td colSpan="100%" className="p-16 text-center text-gray-400 font-black text-xl bg-white dark:bg-slate-800 rounded-2xl shadow-sm">Matriz Vazia.</td></tr>
                                    ) : (
                                        filteredData.map((row, rowIndex) => (
                                            <tr key={`row-${rowIndex}`} className="matrix-row group">
                                                <td>{safeString(row[procColName]) || '-'}</td>
                                                {insurances.map((ins, i) => {
                                                    const val = safeString(row[ins]); const valLower = val.toLowerCase();
                                                    const isNo = valLower === 'x' || valLower === 'n√£o' || valLower === 'nao' || valLower === 'n';
                                                    const isEmpty = val === '' || val === '-';
                                                    return (
                                                        <td key={`cell-${rowIndex}-${i}`}>
                                                            {isNo ? <div className="mx-auto w-8 h-8 flex items-center justify-center rounded-full bg-red-100 text-red-600 shadow-inner" title="N√£o Cobre"><i className="ph-bold ph-x text-lg"></i></div>
                                                            : isEmpty ? <span className="text-gray-300 dark:text-slate-600 font-bold">-</span>
                                                            : <div className="flex flex-col items-center justify-center gap-1 group/tooltip relative cursor-help">
                                                                <div className="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600 shadow-inner"><i className="ph-bold ph-check text-lg"></i></div>
                                                                <span className="text-[9px] font-bold text-gray-500 bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded uppercase max-w-[100px] truncate">{val}</span>
                                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max max-w-[200px] bg-slate-900 text-white text-xs font-bold p-3 rounded-lg shadow-xl opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible z-50 whitespace-normal text-left transition-all border border-slate-700">
                                                                    <span className="block text-[10px] text-gray-400 mb-1 uppercase tracking-widest">{safeString(ins)}</span>{val}
                                                                </div>
                                                            </div>}
                                                        </td>
                                                    );
                                                })}
                                                {canEdit && (
                                                    <td className="border-l border-gray-100 dark:border-slate-700">
                                                        <div className="flex justify-center gap-2 opacity-30 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={()=>openModal(row, allKeys)} className="w-8 h-8 flex items-center justify-center bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition shadow-sm"><i className="ph-bold ph-pencil-simple"></i></button>
                                                            <button onClick={()=>{if(confirm('Excluir?')) handleDelete(row.ID)}} className="w-8 h-8 flex items-center justify-center bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm"><i className="ph-bold ph-trash"></i></button>
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const CorpoClinicoCards = ({ data, canEdit, openModal, handleDelete }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            const filtered = safeData.filter(m => m && typeof m === 'object' && (safeString(m.M√©dico).toLowerCase().includes(search.toLowerCase()) || safeString(m.Especialidade).toLowerCase().includes(search.toLowerCase())));

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center bg-white dark:bg-slate-800 p-5 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700">
                        <div className="relative w-full sm:w-96"><i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-xl"></i><input type="text" placeholder="Buscar m√©dico..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold transition text-gray-800 dark:text-white" /></div>
                        {canEdit && <button onClick={()=>openModal({})} className="bg-primary text-white px-8 py-4 rounded-custom font-black shadow-lg hover:-translate-y-1 transition flex items-center gap-2"><i className="ph-bold ph-user-plus text-xl"></i> Cadastrar M√©dico</button>}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filtered.map((med, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 p-6 shadow-sm border border-gray-100 dark:border-slate-700 rounded-[2.5rem] relative overflow-hidden group card-hover flex flex-col">
                                <div className="absolute top-0 inset-x-0 h-24 bg-gray-100 dark:bg-slate-900" style={{backgroundColor: med.Cor_Selo ? `${safeString(med.Cor_Selo)}20` : ''}}></div>
                                <div className="relative z-10 flex flex-col items-center text-center mt-4">
                                    {med.Foto_URL ? <img src={formatImageUrl(med.Foto_URL)} className="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-lg mb-4" /> : <div className="w-24 h-24 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center text-3xl font-black text-gray-400 border-4 border-gray-50 dark:border-slate-800 shadow-lg mb-4">{safeString(med.M√©dico || 'M').charAt(0)}</div>}
                                    <h3 className="font-black text-xl leading-tight text-gray-900 dark:text-white">{safeString(med.M√©dico) || 'Sem Nome'}</h3>
                                    <p className="text-sm font-bold text-primary mb-3 mt-1 uppercase tracking-wide" style={{color: med.Cor_Selo || 'var(--color-primary)'}}>{safeString(med.Especialidade) || 'Cl√≠nico'}</p>
                                    <div className="w-full bg-gray-50 dark:bg-slate-900 rounded-2xl p-4 mt-auto space-y-2 text-left">
                                        {med.CRM && <p className="text-xs font-bold text-gray-500 flex justify-between"><span>CRM</span> <span className="text-gray-800 dark:text-slate-200">{safeString(med.CRM)}</span></p>}
                                        {med['C√≥digo UNIMED'] && <p className="text-xs font-bold text-gray-500 flex justify-between"><span>UNIMED</span> <span className="text-gray-800 dark:text-slate-200">{safeString(med['C√≥digo UNIMED'])}</span></p>}
                                        {med.Segmento && <p className="text-xs font-bold text-gray-500 flex justify-between"><span>Segmento</span> <span className="bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-slate-200 px-2 rounded-md">{safeString(med.Segmento)}</span></p>}
                                    </div>
                                </div>
                                {canEdit && (
                                    <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                                        <button onClick={()=>openModal(med)} className="w-8 h-8 bg-white dark:bg-slate-700 text-blue-600 rounded-full shadow hover:bg-blue-600 hover:text-white flex items-center justify-center"><i className="ph-bold ph-pencil-simple"></i></button>
                                        <button onClick={()=>{if(confirm('Excluir?')) handleDelete(med.ID)}} className="w-8 h-8 bg-white dark:bg-slate-700 text-red-600 rounded-full shadow hover:bg-red-600 hover:text-white flex items-center justify-center"><i className="ph-bold ph-trash"></i></button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ContatosViewTabs = ({ data, canEdit, openModal, handleDelete, schema }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [search, setSearch] = useState('');
            const [activeTab, setActiveTab] = useState('Ramal'); 
            const filtered = safeData.filter(c => c && safeString(c.Tipo) === activeTab && Object.values(c).some(v=>safeString(v).toLowerCase().includes(search.toLowerCase())));

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 rounded-custom p-4 shadow-sm border border-gray-100 dark:border-slate-700 flex justify-between items-center gap-4">
                        <div className="flex bg-gray-50 dark:bg-slate-900 p-2 rounded-2xl gap-2 w-full md:w-auto">
                            <button onClick={()=>setActiveTab('Ramal')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Ramal'?'bg-white dark:bg-slate-800 text-primary shadow-md':'text-gray-500'}`}>üìû Ramais</button>
                            <button onClick={()=>setActiveTab('Email')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Email'?'bg-white dark:bg-slate-800 text-secondary shadow-md':'text-gray-500'}`}>üìß E-mails</button>
                            <button onClick={()=>setActiveTab('Telefone')} className={`px-6 py-3 rounded-xl font-black transition-all ${activeTab==='Telefone'?'bg-white dark:bg-slate-800 text-green-600 shadow-md':'text-gray-500'}`}>üì± Externos</button>
                        </div>
                        {canEdit && <button onClick={()=>openModal({Tipo: activeTab}, schema)} className="bg-primary text-white font-black px-6 py-3 rounded-xl shadow-md hover:-translate-y-1 transition"><i className="ph-bold ph-plus"></i> Novo Contato</button>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filtered.map((item, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-[2rem] p-6 shadow-sm card-hover relative group">
                                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50 dark:bg-slate-900 px-3 py-1 rounded-full mb-3 inline-block">{safeString(item.Local_Setor) || 'Sem Local'}</span>
                                <h3 className="font-black text-xl text-gray-900 dark:text-white mb-1">{safeString(item.Nome_Contato) || 'Sem Nome'}</h3>
                                <p className={`text-xl font-black mt-3 p-3 rounded-xl ${activeTab==='Ramal'?'bg-blue-50 text-blue-700':activeTab==='Email'?'bg-orange-50 text-orange-700':'bg-green-50 text-green-700'}`}>{safeString(item.Valor_Contato)}</p>
                                {item.Anotacoes && <p className="text-xs font-medium text-gray-500 mt-4 leading-tight">{safeString(item.Anotacoes)}</p>}
                                
                                {canEdit && (
                                    <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onClick={()=>openModal(item, schema)} className="p-2 text-blue-600 bg-white shadow rounded-lg hover:bg-blue-600 hover:text-white"><i className="ph-bold ph-pencil-simple"></i></button>
                                        <button onClick={()=>{if(confirm('Excluir?')) handleDelete(item.ID)}} className="p-2 text-red-600 bg-white shadow rounded-lg hover:bg-red-600 hover:text-white"><i className="ph-bold ph-trash"></i></button>
                                    </div>
                                )}
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="col-span-full p-20 text-center text-gray-400 font-bold border-2 border-dashed rounded-3xl">Nenhum {activeTab} cadastrado.</div>}
                    </div>
                </div>
            )
        };

        const ChatModerno = ({ chatData, user, onSaveChat, onRefresh }) => {
            const [msg, setMsg] = useState('');
            const [activeRoom, setActiveRoom] = useState('Geral'); 
            
            const isAdmin = user && ['admin', 'supervisor'].some(r => safeString(user['N√≠vel de Acesso']).toLowerCase().includes(r));
            const myName = safeString(user['Nome Completo']);
            const chatLog = Array.isArray(chatData) ? chatData : [];
            
            const isGeral = activeRoom === 'Geral';
            const mensagensRoom = chatLog.filter(m => {
                if(isGeral) return m.Destinatario === 'Geral';
                return (m.Nome === myName && m.Destinatario === activeRoom) || (m.Nome === activeRoom && m.Destinatario === myName);
            }).sort((a,b) => new Date(a.Data_Hora) - new Date(b.Data_Hora));

            const handleSend = async (e) => {
                e.preventDefault(); if(!msg)return;
                let dest = activeRoom;
                if(!isAdmin && activeRoom === 'Supervis√£o') dest = 'Supervis√£o';
                await onSaveChat('CHAT_MENSAGENS', {ID:'', Data_Hora:new Date().toISOString(), Nome:myName, Mensagem:msg, Destinatario:dest}, false);
                setMsg(''); onRefresh();
            };

            return (
                <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-xl border border-gray-100 dark:border-slate-700 h-[80vh] flex overflow-hidden animate-fade-in">
                    <div className="w-1/3 border-r border-gray-100 dark:border-slate-700 bg-gray-50/50 dark:bg-slate-900/50 flex flex-col">
                        <div className="p-6 border-b border-gray-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                            <h2 className="text-2xl font-black flex items-center gap-3"><i className="ph-fill ph-chats-circle text-primary"></i> Comunica√ß√£o</h2>
                        </div>
                        <div className="p-4 space-y-2 overflow-y-auto">
                            <div onClick={()=>setActiveRoom('Geral')} className={`p-4 rounded-2xl cursor-pointer font-bold flex items-center gap-3 transition ${activeRoom==='Geral'?'bg-primary text-white shadow-md':'hover:bg-gray-100 dark:hover:bg-slate-800'}`}>
                                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i className="ph-fill ph-users text-xl"></i></div> F√≥rum da Equipe
                            </div>
                            <div onClick={()=>setActiveRoom(isAdmin?'Caixa de Entrada':'Supervis√£o')} className={`p-4 rounded-2xl cursor-pointer font-bold flex items-center justify-between transition ${activeRoom!=='Geral'?'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md':'hover:bg-gray-100 dark:hover:bg-slate-800'}`}>
                                <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white/20 dark:bg-black/10 flex items-center justify-center"><i className="ph-fill ph-shield-star text-xl"></i></div> {isAdmin?'Caixa de Entrada':'Falar c/ Supervis√£o'}</div>
                            </div>
                        </div>
                    </div>
                    <div className="w-2/3 flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-gray-50 dark:bg-slate-900">
                        <div className="p-6 bg-white/80 dark:bg-slate-800/80 backdrop-blur border-b border-gray-100 dark:border-slate-700 flex justify-between items-center shadow-sm z-10">
                            <h3 className="font-black text-xl">{activeRoom}</h3>
                            <button onClick={()=>onRefresh()} className="w-10 h-10 bg-gray-100 dark:bg-slate-700 rounded-full flex items-center justify-center hover:text-primary transition"><i className="ph-bold ph-arrows-clockwise"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-8 space-y-6 flex flex-col custom-scrollbar">
                            {mensagensRoom.length === 0 && <div className="m-auto text-gray-400 font-bold bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center">Nenhuma mensagem neste canal.</div>}
                            {mensagensRoom.map((m, i) => {
                                const isMe = m.Nome === myName;
                                return (
                                    <div key={i} className={`flex flex-col gap-1 max-w-[80%] ${isMe ? 'self-end items-end' : 'self-start items-start'} animate-fade-in`}>
                                        <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest mx-2">{safeString(m.Nome)}</span>
                                        <div className={`p-5 rounded-2xl shadow-md text-sm font-medium ${isMe ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-bl-none'}`}>
                                            {safeString(m.Mensagem)}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                        <form onSubmit={handleSend} className="p-5 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 flex gap-4 shrink-0 z-10">
                            <input type="text" value={msg} onChange={e=>setMsg(e.target.value)} placeholder="Escreva a sua mensagem..." className="flex-1 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-full px-6 py-4 outline-none focus:ring-2 focus:ring-primary font-bold transition text-gray-800 dark:text-white" />
                            <button type="submit" className="w-14 h-14 rounded-full bg-primary text-white flex items-center justify-center shadow-lg hover:scale-105 transition transform"><i className="ph-fill ph-paper-plane-tilt text-xl"></i></button>
                        </form>
                    </div>
                </div>
            )
        };

        const MapaSalasView = ({ escalas }) => {
            const safeEscalas = Array.isArray(escalas) ? escalas : [];
            const todayStr = new Date().toLocaleDateString('pt-BR');
            const todayEscalas = safeEscalas.filter(e => {
                if(!e || typeof e !== 'object') return false;
                const escDate = safeString(e.Data); const escTipo = safeString(e.Tipo_Profissional).toLowerCase(); const escStatus = safeString(e.Status).toLowerCase();
                return (escDate.includes(todayStr) || escDate.includes(todayStr.substring(0,5))) && escTipo.includes('m√©dico') && escStatus.includes('trabalhando');
            });
            const board = {};
            todayEscalas.forEach(e => {
                const u = safeString(e.Unidade) || 'Geral'; const s = safeString(e.Setor_Consultorio) || 'Sem Sala';
                if(!board[u]) board[u] = {}; if(!board[u][s]) board[u][s] = []; board[u][s].push(e);
            });
            return (
                <div className="flex gap-6 overflow-x-auto pb-8 custom-scrollbar items-start min-h-[60vh] pt-4">
                    {Object.keys(board).length === 0 && <div className="w-full flex flex-col items-center justify-center p-20 text-gray-400 font-black text-2xl border-2 border-dashed dark:border-slate-700 rounded-[3rem] mt-10"><i className="ph-fill ph-coffee text-6xl mb-4 opacity-50"></i> Nenhum m√©dico escalado hoje.</div>}
                    {Object.keys(board).sort().map(unidade => (
                        <div key={unidade} className="w-[400px] shrink-0 flex flex-col">
                            <h3 className="text-2xl font-black text-gray-800 dark:text-white mb-6 flex items-center gap-3 px-2"><div className="w-10 h-10 bg-primary text-white rounded-xl flex items-center justify-center shadow-md"><i className="ph-fill ph-buildings text-xl"></i></div> {unidade}</h3>
                            <div className="bg-gray-100/80 dark:bg-slate-800/80 p-5 rounded-[2.5rem] border border-gray-200 dark:border-slate-700 space-y-6">
                                {Object.keys(board[unidade]).sort().map(setor => (
                                    <div key={setor} className="bg-white dark:bg-slate-900 rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-slate-700 relative overflow-hidden">
                                        <div className="absolute top-0 inset-x-0 h-1 bg-primary/20"></div>
                                        <h4 className="text-sm font-black text-primary uppercase tracking-widest mb-4 flex items-center gap-2"><i className="ph-fill ph-door"></i> {setor}</h4>
                                        <div className="space-y-3">
                                            {board[unidade][setor].map((med, i) => (
                                                <div key={i} className="flex items-center gap-4 bg-gray-50 dark:bg-slate-800 p-4 rounded-2xl border border-transparent group shadow-sm">
                                                    <div className="w-12 h-12 rounded-full bg-gradient-to-tr from-primary to-blue-500 text-white flex items-center justify-center text-xl font-black shadow-md shrink-0">{safeString(med.Nome_Profissional || 'M').charAt(0)}</div>
                                                    <div className="flex-1 overflow-hidden"><p className="font-black text-base truncate text-gray-900 dark:text-white">{safeString(med.Nome_Profissional)}</p><p className="text-xs font-bold text-gray-500 truncate mt-0.5"><i className="ph-fill ph-clock"></i> {safeString(med.Horario)}</p></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            )
        };

        const EscalasContainer = ({ sheetData, user, onRefresh, showToast }) => {
            const [activeSubTab, setActiveSubTab] = useState('M√©dicos');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [loadingAction, setLoadingAction] = useState(false);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null); 
            const [selectedPerson, setSelectedPerson] = useState(null); 
            const [datesToSave, setDatesToSave] = useState([]); 

            const nivelKey = user && typeof user === 'object' ? Object.keys(user).find(k => safeString(k).toLowerCase().includes('acesso')) : null;
            const canEdit = nivelKey && ['admin', 'supervisor'].some(role => safeString(user[nivelKey]).toLowerCase().includes(role));
            const escalas = Array.isArray(sheetData['ESCALAS']) ? sheetData['ESCALAS'] : [];
            const corpoClinico = Array.isArray(sheetData['CORPO CLINICO']) ? sheetData['CORPO CLINICO'] : [];
            const usuarios = Array.isArray(sheetData['USUARIOS']) ? sheetData['USUARIOS'] : [];
            
            const filteredEscalas = escalas.filter(esc => {
                if(!esc || typeof esc !== 'object') return false;
                const tipo = safeString(esc.Tipo_Profissional).toLowerCase();
                if (activeSubTab === 'M√©dicos') return tipo.includes('m√©dico') || tipo.includes('medico') || tipo === '';
                else return tipo.includes('colaborador') || tipo.includes('equipe') || tipo.includes('enfermagem');
            });

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();

            const handleSave = async (e) => {
                e.preventDefault(); if(datesToSave.length === 0) return showToast('Selecione uma data.', 'error');
                setLoadingAction(true); let err = false;
                for (let d of datesToSave) {
                    const rec = { ...formData, Data: d }; if(datesToSave.length > 1) rec.ID = ''; 
                    const res = await api.saveRecord('ESCALAS', rec, !!formData.ID && datesToSave.length === 1);
                    if(!res.success) err = true;
                }
                setLoadingAction(false); if(!err) { setIsModalOpen(false); onRefresh('ESCALAS'); showToast('Salvo!'); }
            };

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 rounded-custom p-4 shadow-sm border border-gray-100 dark:border-slate-700 flex justify-between items-center gap-4">
                        <div className="flex bg-gray-50 dark:bg-slate-900 p-2 rounded-2xl gap-2 w-full md:w-auto overflow-x-auto hide-scroll">
                            <button onClick={() => setActiveSubTab('M√©dicos')} className={`px-6 py-3.5 rounded-xl font-black transition-all ${activeSubTab === 'M√©dicos' ? 'bg-white dark:bg-slate-800 text-primary shadow-md' : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-800'}`}>Lista M√©dicos</button>
                            <button onClick={() => setActiveSubTab('Colaboradores')} className={`px-6 py-3.5 rounded-xl font-black transition-all ${activeSubTab === 'Colaboradores' ? 'bg-white dark:bg-slate-800 text-secondary shadow-md' : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-800'}`}>Lista Equipe</button>
                            <button onClick={() => setActiveSubTab('Mapa')} className={`px-6 py-3.5 rounded-xl font-black transition-all ${activeSubTab === 'Mapa' ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-800'}`}>Mapa de Salas</button>
                        </div>
                        {canEdit && activeSubTab !== 'Mapa' && <button onClick={() => { setFormData({ ID: '', Tipo_Profissional: activeSubTab === 'M√©dicos' ? 'M√©dico' : 'Colaborador', Nome_Profissional: '', Turno: 'Manh√£', Horario: '', Unidade: '', Setor_Consultorio: '', Status: 'Trabalhando', Tipo_Atendimento: '-' }); setDatesToSave([]); setIsModalOpen(true); }} className="bg-primary text-white font-black px-8 py-4 rounded-custom shadow-lg hover:-translate-y-1 transition"><i className="ph-bold ph-calendar-plus"></i> Lan√ßar</button>}
                    </div>

                    {activeSubTab === 'Mapa' ? <MapaSalasView escalas={escalas} /> : (
                        <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-sm border border-gray-100 dark:border-slate-700 p-8 relative overflow-hidden">
                            <div className="flex justify-between items-center mb-10">
                                <button onClick={()=>setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1))} className="w-14 h-14 bg-gray-50 dark:bg-slate-900 rounded-2xl"><i className="ph-bold ph-caret-left"></i></button>
                                <h2 className="text-4xl font-black capitalize text-gray-900 dark:text-white">{currentMonth.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h2>
                                <button onClick={()=>setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1))} className="w-14 h-14 bg-gray-50 dark:bg-slate-900 rounded-2xl"><i className="ph-bold ph-caret-right"></i></button>
                            </div>
                            <div className="grid grid-cols-7 gap-4 mb-4 text-center"><div className="font-black text-gray-400">D</div><div className="font-black text-gray-400">S</div><div className="font-black text-gray-400">T</div><div className="font-black text-gray-400">Q</div><div className="font-black text-gray-400">Q</div><div className="font-black text-gray-400">S</div><div className="font-black text-gray-400">S</div></div>
                            <div className="grid grid-cols-7 gap-4 relative z-10">
                                {Array(firstDayOfMonth).fill(null).map((_, i) => <div key={`e-${i}`} className="aspect-square opacity-20 bg-gray-50 dark:bg-slate-900 rounded-3xl" />)}
                                {Array(daysInMonth).fill(null).map((_, i) => {
                                    const day = i + 1;
                                    const dateStrCompleto = `${String(day).padStart(2, '0')}/${String(currentMonth.getMonth() + 1).padStart(2, '0')}/${currentMonth.getFullYear()}`;
                                    const pessoasNoDia = filteredEscalas.filter(e => safeString(e.Data).includes(dateStrCompleto) || safeString(e.Data).includes(`${String(day).padStart(2, '0')}/${String(currentMonth.getMonth() + 1).padStart(2, '0')}/${String(currentMonth.getFullYear()).slice(2)}`));
                                    const isToday = dateStrCompleto === new Date().toLocaleDateString('pt-BR');
                                    return (
                                        <div key={day} onClick={() => setSelectedDate(dateStrCompleto)} className={`aspect-square rounded-[2rem] border-2 p-4 flex flex-col cursor-pointer transition-all ${isToday ? 'border-primary bg-blue-50/50 dark:bg-blue-900/20 shadow-md' : 'border-gray-100 dark:border-slate-700 hover:border-primary/50 bg-white dark:bg-slate-800'}`}>
                                            <span className={`text-2xl font-black ${isToday ? 'text-primary' : 'text-gray-900 dark:text-white'}`}>{day}</span>
                                            <div className="mt-auto w-full space-y-1.5">{pessoasNoDia.length > 0 && <div className={`w-full text-center text-xs font-black py-2 rounded-xl shadow-sm ${activeSubTab==='M√©dicos' ? 'bg-primary text-white' : 'bg-secondary text-white'}`}>{pessoasNoDia.length} Plant√£o</div>}</div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    )}
                    
                    {selectedDate && !selectedPerson && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 glass-modal" onClick={() => setSelectedDate(null)}>
                            <div className="bg-white dark:bg-slate-800 rounded-[3rem] w-full max-w-5xl p-10 shadow-2xl animate-pop-in relative border border-gray-100 dark:border-slate-700" onClick={e => e.stopPropagation()}>
                                <button onClick={()=>setSelectedDate(null)} className="absolute top-8 right-8 w-12 h-12 bg-gray-100 dark:bg-slate-700 hover:bg-red-500 hover:text-white rounded-full"><i className="ph-bold ph-x"></i></button>
                                <h3 className="text-4xl font-black mb-10 flex items-center gap-4 text-gray-900 dark:text-white">Plant√£o dia {selectedDate}</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-h-[60vh] overflow-y-auto hide-scroll pb-4">
                                    {filteredEscalas.filter(e => safeString(e.Data).includes(selectedDate) || safeString(e.Data).includes(selectedDate.substring(0,6) + selectedDate.substring(8,10))).map((esc, i) => (
                                        <div key={i} onClick={() => setSelectedPerson(safeString(esc.Nome_Profissional))} className="bg-white dark:bg-slate-900 border-2 border-gray-100 dark:border-slate-700 rounded-3xl p-6 cursor-pointer card-hover hover:border-primary flex flex-col">
                                            <h4 className="font-black text-xl mb-3 text-gray-900 dark:text-white">{safeString(esc.Nome_Profissional)}</h4>
                                            <p className="text-sm font-black bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-xl mb-4 text-gray-600 dark:text-slate-300">{safeString(esc.Turno)} ‚Ä¢ {safeString(esc.Horario)}</p>
                                            <div className="mt-auto flex justify-between"><span className="text-[10px] font-black uppercase px-4 py-1.5 rounded-full bg-green-100 text-green-800">{safeString(esc.Status)}</span><span className="text-primary text-xs font-black">Ver M√™s</span></div>
                                        </div>
                                    ))}
                                    {filteredEscalas.filter(e => safeString(e.Data).includes(selectedDate)).length === 0 && <div className="col-span-full text-center text-gray-400 font-black text-2xl p-12">Ningu√©m escalado.</div>}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {selectedPerson && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 backdrop-blur-xl bg-gray-900/60 animate-fade-in" onClick={() => setSelectedPerson(null)}>
                            <div className="bg-white dark:bg-slate-800 rounded-[3rem] w-full max-w-5xl p-10 shadow-2xl animate-pop-in relative border border-white dark:border-slate-700" onClick={e => e.stopPropagation()}>
                                <button onClick={()=>setSelectedPerson(null)} className="absolute top-8 right-8 w-12 h-12 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 rounded-full"><i className="ph-bold ph-x"></i></button>
                                <div className="flex items-center gap-6 mb-10 border-b border-gray-100 dark:border-slate-700 pb-8">
                                    <div className="w-20 h-20 rounded-[2rem] bg-gradient-to-br from-primary to-blue-500 text-white flex items-center justify-center text-4xl font-black">{safeString(selectedPerson || 'U').charAt(0)}</div>
                                    <div><h2 className="text-4xl font-black text-gray-900 dark:text-white">{selectedPerson}</h2><p className="text-primary font-black uppercase text-sm mt-2">Agenda Mensal</p></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 max-h-[55vh] overflow-y-auto hide-scroll pb-4">
                                    {filteredEscalas.filter(e => e && safeString(e.Nome_Profissional) === selectedPerson).map((esc, i) => (
                                        <div key={i} className="border-2 border-gray-100 dark:border-slate-700 rounded-3xl p-6 relative group bg-white dark:bg-slate-900 shadow-sm">
                                            <div className="flex justify-between items-center mb-4"><span className="font-black text-2xl text-gray-900 dark:text-white">{safeString(esc.Data).substring(0,5)}</span><span className="bg-gray-100 dark:bg-slate-800 px-3 py-1 rounded-xl text-xs font-black text-gray-600 dark:text-slate-300">{safeString(esc.Turno)}</span></div>
                                            <div className="space-y-2 mb-2"><p className="text-sm font-bold opacity-80">{safeString(esc.Horario)}</p><p className="text-sm font-bold opacity-80">{safeString(esc.Unidade)}</p></div>
                                            {canEdit && <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onClick={async()=>{if(confirm('Excluir?')){ await api.deleteRecord('ESCALAS', esc.ID); onRefresh('ESCALAS'); setSelectedPerson(null); setSelectedDate(null); }}} className="w-8 h-8 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded-lg"><i className="ph-bold ph-trash"></i></button></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 glass-modal" onMouseDown={()=>setIsModalOpen(false)}>
                            <div className="bg-white dark:bg-slate-800 rounded-[3rem] w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl animate-pop-in border border-gray-100 dark:border-slate-700" onMouseDown={e=>e.stopPropagation()}>
                                <div className="p-8 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-gray-50/50 dark:bg-slate-900"><h3 className="text-3xl font-black text-gray-900 dark:text-white">Lan√ßamento em Lote</h3><button onClick={() => setIsModalOpen(false)} className="w-12 h-12 bg-white dark:bg-slate-700 rounded-full hover:bg-red-500 hover:text-white shadow-sm text-xl"><i className="ph-bold ph-x"></i></button></div>
                                <div className="p-8 flex flex-col lg:flex-row gap-12"><div className="lg:w-1/2">
                                    <h4 className="font-black mb-6 text-xl">1. Selecione as Datas</h4>
                                    <div className="grid grid-cols-7 gap-2">
                                        {Array(firstDayOfMonth).fill(null).map((_, i) => <div key={`empty-${i}`} />)}
                                        {Array(daysInMonth).fill(null).map((_, i) => {
                                            const day = i + 1; const dStr = `${String(day).padStart(2, '0')}/${String(currentMonth.getMonth() + 1).padStart(2, '0')}/${currentMonth.getFullYear()}`; const sel = datesToSave.includes(dStr);
                                            return <button type="button" key={day} onClick={() => { if(sel) setDatesToSave(datesToSave.filter(x => x !== dStr)); else setDatesToSave([...datesToSave, dStr]); }} className={`w-full aspect-square rounded-2xl font-black text-lg transition-all ${sel ? 'bg-primary text-white shadow-xl scale-110' : 'bg-white dark:bg-slate-800 border-2 border-gray-100 dark:border-slate-700 hover:border-primary shadow-sm'}`}>{day}</button>
                                        })}
                                    </div>
                                </div>
                                <div className="lg:w-1/2"><h4 className="font-black mb-6 text-xl">2. Dados</h4>
                                    <form id="esc-form" onSubmit={handleSave} className="space-y-6">
                                        <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase">Profissional</label><select className="w-full px-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-black" value={safeString(formData.Nome_Profissional)} onChange={e => setFormData({...formData, Nome_Profissional: e.target.value})} required><option value="">Selecione...</option>{activeSubTab === 'M√©dicos' ? corpoClinico.map((m,i) => <option key={i} value={safeString(m?.M√©dico)}>{safeString(m?.M√©dico)}</option>) : usuarios.map((u,i) => <option key={i} value={safeString(u?.['Nome Completo'])}>{safeString(u?.['Nome Completo'])}</option>)}</select></div>
                                        <div className="grid grid-cols-2 gap-6">
                                            <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase">Turno</label><select className="w-full px-5 py-4 bg-gray-50 border rounded-custom outline-none font-bold" value={safeString(formData.Turno)} onChange={e => setFormData({...formData, Turno: e.target.value})}><option value="Manh√£">Manh√£</option><option value="Tarde">Tarde</option><option value="Noite">Noite</option></select></div>
                                            <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase">Hor√°rio</label><input type="text" className="w-full px-5 py-4 bg-gray-50 border rounded-custom outline-none font-bold" value={safeString(formData.Horario)} onChange={e => setFormData({...formData, Horario: e.target.value})} /></div>
                                        </div>
                                    </form>
                                </div></div>
                                <div className="p-6 border-t flex justify-end gap-4"><button onClick={() => setIsModalOpen(false)} className="px-10 py-4 font-black">Cancelar</button><button type="submit" form="esc-form" disabled={loadingAction} className="px-12 py-4 bg-primary text-white font-black rounded-custom shadow-xl">Gravar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DesignInterfacePanel = ({ sheetData, onRefresh, showToast }) => {
            const configs = Array.isArray(sheetData['CONFIGURACOES']) ? sheetData['CONFIGURACOES'] : [];
            const getConfig = (chave, def) => { const item = configs.find(c => c && c.Chave === chave); return item ? item.Valor : def; };

            const [primary, setPrimary] = useState(getConfig('cor_primaria', '#1E40AF'));
            const [secondary, setSecondary] = useState(getConfig('cor_secundaria', '#F97316'));
            const [bg, setBg] = useState(getConfig('cor_fundo', '#F8FAFC'));
            const [logo, setLogo] = useState(getConfig('logo_url', ''));
            const [fontFamily, setFontFamily] = useState(getConfig('font_family', 'Inter'));
            const [borderRadius, setBorderRadius] = useState(getConfig('border_radius', '1.5rem'));
            const [saving, setSaving] = useState(false);

            const handleSaveDesign = async (e) => {
                e.preventDefault(); setSaving(true);
                const settingsToSave = [
                    { key: 'cor_primaria', val: primary }, { key: 'cor_secundaria', val: secondary },
                    { key: 'cor_fundo', val: bg }, { key: 'logo_url', val: logo },
                    { key: 'font_family', val: fontFamily }, { key: 'border_radius', val: borderRadius }
                ];
                for (let setting of settingsToSave) {
                    const existing = configs.find(c => c && c.Chave === setting.key);
                    await api.saveRecord('CONFIGURACOES', { 'ID': existing ? existing.ID : '', 'Chave': setting.key, 'Valor': setting.val }, !!existing);
                }
                await onRefresh('CONFIGURACOES'); setSaving(false); showToast("Design atualizado!", "success");
            };

            return (
                <div className="bg-white dark:bg-slate-800 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700 p-8 max-w-5xl mx-auto animate-fade-in">
                    <h2 className="text-3xl font-black mb-8"><i className="ph-fill ph-magic-wand text-primary"></i> Estilo do Portal</h2>
                    <form onSubmit={handleSaveDesign} className="space-y-8">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Cores</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Prim√°ria</label><input type="color" value={primary} onChange={(e) => setPrimary(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Secund√°ria</label><input type="color" value={secondary} onChange={(e) => setSecondary(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Fundo Claro</label><input type="color" value={bg} onChange={(e) => setBg(e.target.value)} className="w-full h-10 rounded-lg cursor-pointer" /></div>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Formatos</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Bordas</label><select className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800" value={borderRadius} onChange={e=>setBorderRadius(e.target.value)}><option value="0px">Reto</option><option value="0.5rem">Suave</option><option value="1.5rem">Moderno</option></select></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">Fonte</label><select className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800" value={fontFamily} onChange={e=>setFontFamily(e.target.value)}><option value="Inter">Inter</option><option value="Roboto">Roboto</option></select></div>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-custom border border-gray-100 dark:border-slate-700 space-y-4">
                                <h3 className="font-black text-gray-800 dark:text-white">Logo do Portal</h3>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">URL (Drive ou Site)</label><input type="url" value={logo} onChange={e=>setLogo(e.target.value)} className="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 text-xs font-medium" placeholder="https://..." /></div>
                            </div>
                        </div>
                        <div className="flex justify-end"><button type="submit" disabled={saving} className="bg-primary text-white font-black py-4 px-10 rounded-custom shadow-xl">{saving?'Salvando...':'Salvar Design'}</button></div>
                    </form>
                </div>
            )
        };

        const DefaultTableView = ({ title, schema, filteredData, canEdit, openModal, handleDelete, search, setSearch }) => {
            return (
                <div className="bg-white dark:bg-slate-800 rounded-custom shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden animate-fade-in">
                    <div className="p-8 border-b border-gray-50 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-6 bg-gray-50/50 dark:bg-slate-900/50">
                        <h2 className="text-3xl font-black tracking-tight flex items-center gap-3 text-gray-900 dark:text-white"><div className="w-3 h-8 bg-primary rounded-full"></div> {title}</h2>
                        <div className="flex gap-4 w-full md:w-auto">
                            <div className="relative flex-1 md:w-96">
                                <i className="ph-bold ph-magnifying-glass absolute left-5 top-4 text-gray-400 text-xl"></i>
                                <input type="text" placeholder="Pesquisar em tudo..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 shadow-sm border border-gray-200 dark:border-slate-700 rounded-full outline-none focus:ring-2 focus:ring-primary font-bold transition text-gray-800 dark:text-white" />
                            </div>
                            {canEdit && <button onClick={() => openModal(null, schema)} className="bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-black px-10 py-4 rounded-full shadow-xl hover:-translate-y-1 transition flex items-center gap-2 shrink-0"><i className="ph-bold ph-plus text-xl"></i> Novo</button>}
                        </div>
                    </div>
                    <div className="overflow-x-auto p-4">
                        <table className="w-full text-left border-collapse min-w-[800px]">
                            <thead>
                                <tr className="text-gray-400 text-[10px] uppercase tracking-widest border-b-2 border-gray-100 dark:border-slate-700">
                                    {schema.filter(c=>safeString(c)!=='ID').map((col, i) => <th key={`th-${i}`} className="p-6 font-black">{safeString(col)}</th>)}
                                    {canEdit && <th className="p-6 font-black text-right">A√ß√µes</th>}
                                </tr>
                            </thead>
                            <tbody className="text-sm font-bold text-gray-800 dark:text-slate-200">
                                {filteredData.length === 0 ? <tr><td colSpan="100%" className="text-center p-20 text-gray-400 font-black text-xl border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-custom m-4">Nenhum dado cadastrado ou encontrado.</td></tr> : 
                                filteredData.map((row, i) => (
                                    <tr key={`tr-${i}`} className="hover:bg-blue-50/30 dark:hover:bg-slate-700/30 border-b border-gray-50 dark:border-slate-700 transition group">
                                        {schema.filter(c=>safeString(c)!=='ID').map((col, j) => (
                                            <td key={`td-${i}-${j}`} className="p-6 whitespace-nowrap">
                                                {safeString(col).toLowerCase().includes('url') || safeString(col).toLowerCase().includes('foto') || safeString(col).toLowerCase().includes('imagem') ? (row[col] ? <img src={formatImageUrl(row[col])} className="h-14 w-14 object-cover rounded-2xl shadow-sm border border-gray-200 dark:border-slate-600" /> : <div className="h-14 w-14 bg-gray-100 dark:bg-slate-700 rounded-2xl flex items-center justify-center text-gray-300"><i className="ph-fill ph-image text-xl"></i></div>) :
                                                 safeString(col).toLowerCase().includes('senha') ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' :
                                                 safeString(row[col]) === 'Sim' || safeString(row[col]) === 'Ativo' ? <span className="bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider">{safeString(row[col])}</span> :
                                                 safeString(row[col]) === 'N√£o' || safeString(row[col]) === 'Inativo' ? <span className="bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider">{safeString(row[col])}</span> :
                                                 safeString(row[col]) || '-'}
                                            </td>
                                        ))}
                                        {canEdit && (
                                            <td className="p-6 flex justify-end gap-2 opacity-50 group-hover:opacity-100 transition">
                                                <button onClick={()=>openModal(row, schema)} className="text-blue-600 bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-600 hover:text-white p-3 rounded-xl transition shadow-sm"><i className="ph-bold ph-pencil-simple text-xl"></i></button>
                                                <button onClick={()=>handleDelete(row.ID)} className="text-red-600 bg-red-50 dark:bg-red-900/30 hover:bg-red-600 hover:text-white p-3 rounded-xl transition shadow-sm"><i className="ph-bold ph-trash text-xl"></i></button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const DataTableGeneric = ({ title, tabName, data, user, onRefresh, showToast }) => {
            const safeData = Array.isArray(data) ? data : [];
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({});
            const [loading, setLoading] = useState(false);
            const [search, setSearch] = useState('');
            const [currentSchema, setCurrentSchema] = useState([]);
            
            let dynamicKeys = ['ID'];
            if (safeData.length > 0 && typeof safeData[0] === 'object' && safeData[0] !== null) {
                dynamicKeys = Object.keys(safeData[0]);
            }
            
            const schema = tabSchemas[tabName] || dynamicKeys || ['ID'];
            
            const nivelKey = user && typeof user === 'object' ? Object.keys(user).find(k => safeString(k).toLowerCase().includes('acesso')) : null;
            const canEdit = nivelKey && ['admin', 'supervisor', 'supervis√£o'].some(role => safeString(user[nivelKey]).toLowerCase().includes(role));

            const filteredData = safeData.filter(row => row && typeof row === 'object' && Object.values(row).some(val => safeString(val).toLowerCase().includes(search.toLowerCase())));

            const openModal = (row = null, customSchema = null) => {
                let initial = {};
                const s = customSchema || schema;
                s.forEach(col => initial[col] = row ? safeString(row[col]) : '');
                setFormData(initial);
                setCurrentSchema(s);
                setIsModalOpen(true);
            };

            const handleSave = async (e) => {
                e.preventDefault(); setLoading(true);
                const res = await api.saveRecord(tabName, formData, !!formData.ID);
                setLoading(false);
                if (res && res.success) { setIsModalOpen(false); onRefresh(tabName); showToast('Salvo com sucesso!'); } else { showToast('Erro ao salvar.', 'error') }
            };

            const handleDelete = async (id) => {
                if(confirm('Tem certeza que deseja excluir?')) {
                    const res = await api.deleteRecord(tabName, id);
                    if (res && res.success) { onRefresh(tabName); showToast('Exclu√≠do com sucesso!'); }
                }
            };

            if(tabName === 'CONV√äNIOS') return <><ConveniosMatrixView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} /> {isModalOpen && <ModalForm title="Regra de Conv√™nio" schema={currentSchema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'CORPO CLINICO') return <><CorpoClinicoCards data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} /> {isModalOpen && <ModalForm title="M√©dico" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'CONTATOS') return <><ContatosViewTabs data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} /> {isModalOpen && <ModalForm title="Contato" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'SENHAS E LOGINS GERAIS') return <><SenhasView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} showToast={showToast} /> {isModalOpen && <ModalForm title="Acesso" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'CONSULTA E PROCEDIMENTOS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Consulta/Procedimento" fieldsLeft={['C√≥digo', 'Valor Particular']} fieldsRight={['Valor Particular', 'Preparo', 'Material Utilizado']} descField="Descri√ß√£o" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Proc." schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'EXAMES LABORATORIAIS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Procedimento" fieldsLeft={['C√≥digo', 'Valor']} fieldsRight={['Valor', 'Prazo de Libera√ß√£o', 'Preparo']} descField="Motivo_Indicacao" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Lab." schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'EXAMES DE IMAGEM E OUTROS') return <><SplitView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} titleLabel="Descri√ß√£o" fieldsLeft={['C√≥digo', 'Valor']} fieldsRight={['Valor', 'Prazo de Laudo', 'Onde Encontrar']} imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Exame/Laudo" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'EXAMES DE IMAGEM') return <><CategoryCardsView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} categoryField="Categoria" titleField="Nome do Exame" imageField="Imagem_URL" /> {isModalOpen && <ModalForm title="Exame de Imagem" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'INSTITUTOS') return <><CategoryCardsView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} schema={schema} categoryField="Tabela_Instituto" titleField="Profissional" /> {isModalOpen && <ModalForm title="Instituto/Tabela" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;
            if(tabName === 'MURAL_AVISOS') return <><MuralAvisosView data={safeData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} /> {isModalOpen && <ModalForm title="An√∫ncio / Aviso" schema={schema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}</>;

            return (
                <>
                    <DefaultTableView title={title} schema={schema} filteredData={filteredData} canEdit={canEdit} openModal={openModal} handleDelete={handleDelete} search={search} setSearch={setSearch} />
                    {isModalOpen && <ModalForm title={title} schema={currentSchema} formData={formData} setFormData={setFormData} onSave={handleSave} onClose={()=>setIsModalOpen(false)} loading={loading}/>}
                </>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('Home');
            const [loading, setLoading] = useState(false);
            const [sheetData, setSheetData] = useState({});
            const [chatMessage, setChatMessage] = useState('');
            const [chatFilter, setChatFilter] = useState('Geral'); 
            const [searchGlobal, setSearchGlobal] = useState('');
            
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('theme');
                if(saved) return saved === 'dark';
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [loginErrorMsg, setLoginErrorMsg] = useState('');

            const showToast = (msg, type = 'success') => { setToast({ show: true, message: msg, type }); setTimeout(() => setToast(p => ({ ...p, show: false })), 3500); };

            useEffect(() => {
                if (darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            }, [darkMode]);

            useEffect(() => {
                const init = async () => {
                    if(!window.isFirebaseConfigured) return;
                    const allData = await api.fetchAll(); 
                    if(allData && Object.keys(allData).length > 0) {
                        setSheetData(allData);
                        const conf = allData['CONFIGURACOES'] || [];
                        conf.forEach(c => {
                            if(c.Chave === 'cor_primaria') document.documentElement.style.setProperty('--color-primary', c.Valor);
                            if(c.Chave === 'cor_secundaria') document.documentElement.style.setProperty('--color-secondary', c.Valor);
                            if(c.Chave === 'cor_fundo') document.documentElement.style.setProperty('--color-bg', c.Valor);
                        });
                    }
                }; init();
            }, []);

            const loadData = async (tab) => {
                setLoading(true);
                if (tab === 'Home') {
                    const [news, atend, lembretes, mural] = await Promise.all([api.fetch('NOVIDADES_E_EVENTOS'), api.fetch('CONTROLE_ATENDIMENTOS'), api.fetch('LEMBRETES_HORA'), api.fetch('MURAL_AVISOS')]);
                    setSheetData(prev => ({ ...prev, 'NOVIDADES_E_EVENTOS': news, 'CONTROLE_ATENDIMENTOS': atend, 'LEMBRETES_HORA': lembretes, 'MURAL_AVISOS': mural }));
                } else if (tab === 'ESCALAS') {
                    const [escala, medicos, u] = await Promise.all([api.fetch('ESCALAS'), api.fetch('CORPO CLINICO'), api.fetch('USUARIOS')]);
                    setSheetData(prev => ({ ...prev, 'ESCALAS': escala, 'CORPO CLINICO': medicos, 'USUARIOS': u }));
                } else {
                    const data = await api.fetch(tab); setSheetData(prev => ({ ...prev, [tab]: data }));
                }
                setLoading(false);
            };

            if (!user) {
                const handleLogin = async (e) => {
                    e.preventDefault(); setLoading(true); setLoginErrorMsg('');
                    const res = await api.login(e.target.email.value, e.target.password.value);
                    if (res && res.success) { setUser(res.user); loadData('Home'); } 
                    else { setLoginErrorMsg(res?.message || 'Erro ao conectar com o servidor.'); }
                    setLoading(false);
                };
                return (
                    <div className="min-h-screen bg-medical dark:bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-2xl w-full max-w-md overflow-hidden animate-fade-in border border-gray-100 dark:border-slate-700">
                            <div className="p-12 bg-gradient-to-br from-primary to-blue-800 text-white text-center relative">
                                <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                                <div className="relative z-10">
                                    <div className="w-28 h-28 mx-auto bg-white/10 rounded-[2rem] flex items-center justify-center mb-6 backdrop-blur-sm shadow-xl"><i className="ph-fill ph-heartbeat text-7xl"></i></div>
                                    <h1 className="text-4xl font-black">S√£o Vicente</h1>
                                </div>
                            </div>
                            <form onSubmit={handleLogin} className="p-10 space-y-6">
                                {loginErrorMsg && (
                                    <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-4 rounded-xl flex gap-3 items-start animate-pop-in">
                                        <i className="ph-fill ph-warning-circle text-red-600 dark:text-red-400 text-xl shrink-0 mt-0.5"></i>
                                        <p className="text-sm font-bold text-red-800 dark:text-red-200 leading-tight">{loginErrorMsg}</p>
                                    </div>
                                )}
                                <div><label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">E-mail</label><div className="relative"><i className="ph-fill ph-user absolute left-5 top-4 text-gray-400 text-xl"></i><input name="email" type="email" className="w-full pl-14 pr-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-900 dark:text-white transition" required /></div></div>
                                <div><label className="block text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">Senha</label><div className="relative"><i className="ph-fill ph-lock-key absolute left-5 top-4 text-gray-400 text-xl"></i><input name="password" type="password" className="w-full pl-14 pr-5 py-4 bg-gray-50 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 rounded-custom outline-none focus:ring-2 focus:ring-primary font-bold text-gray-900 dark:text-white transition" required /></div></div>
                                <button type="submit" disabled={loading} className="w-full bg-secondary hover:opacity-90 text-white font-black py-5 rounded-custom shadow-xl shadow-secondary/30 transition transform hover:-translate-y-1">{loading ? 'Conectando...' : 'Acessar Sistema'}</button>
                            </form>
                        </div>
                    </div>
                );
            }

            const menus = [
                { id: 'Home', icon: 'ph-house', label: 'Dashboard Inicial' },
                { id: 'MURAL_AVISOS', icon: 'ph-presentation-chart', label: 'Mural de Avisos' },
                { id: 'ESCALAS', icon: 'ph-calendar-check', label: 'Escalas e Plant√µes' },
                { id: 'CONV√äNIOS', icon: 'ph-file-text', label: 'Matriz de Conv√™nios' },
                { id: 'CORPO CLINICO', icon: 'ph-stethoscope', label: 'Corpo Cl√≠nico' },
                { id: 'CONTATOS', icon: 'ph-address-book', label: 'Contatos R√°pidos' },
                { id: 'CHAT_MENSAGENS', icon: 'ph-chat-circle-dots', label: 'Chat Interno' },
                { id: 'EXAMES DE IMAGEM', icon: 'ph-bone', label: 'Exames de Imagem' },
                { id: 'EXAMES DE IMAGEM E OUTROS', icon: 'ph-files', label: 'Exames e Laudos' },
                { id: 'CONSULTA E PROCEDIMENTOS', icon: 'ph-first-aid-kit', label: 'Consultas' },
                { id: 'EXAMES LABORATORIAIS', icon: 'ph-flask', label: 'Laborat√≥rio' },
                { id: 'INSTITUTOS', icon: 'ph-buildings', label: 'Institutos' },
                { id: 'REMO√á√ïES', icon: 'ph-car', label: 'Remo√ß√µes' },
                { id: 'SENHAS E LOGINS GERAIS', icon: 'ph-lock-key', label: 'Senhas de Sistemas' }
            ];
            const adminMenus = [ { id: 'CONTROLE_ATENDIMENTOS', icon: 'ph-chart-line-up', label: 'Limites Unimed' }, { id: 'USUARIOS', icon: 'ph-users', label: 'Colaboradores' }, { id: 'DESIGN_INTERFACE', icon: 'ph-magic-wand', label: 'Design de Interface' }, { id: 'LEMBRETES_HORA', icon: 'ph-clock', label: 'Avisos do Rel√≥gio' } ];

            const chatMessages = Array.isArray(sheetData['CHAT_MENSAGENS']) ? sheetData['CHAT_MENSAGENS'] : [];
            const filteredChat = chatMessages.filter(m => {
                if(!m) return false;
                if(chatFilter === 'Geral') return safeString(m.Destinatario) !== 'Supervis√£o';
                if(isAdmin) return safeString(m.Destinatario) === 'Supervis√£o' || safeString(m.Destinatario) === 'Colaborador';
                return (safeString(m.Destinatario) === 'Supervis√£o' && safeString(m.Nome) === userName) || (safeString(m.Destinatario) === 'Colaborador' && safeString(m.Mensagem).includes(`Para ${userName}`));
            });

            const letreiros = Array.isArray(sheetData['NOVIDADES_E_EVENTOS']) ? sheetData['NOVIDADES_E_EVENTOS'].filter(n => n && (safeString(n.Tipo) === 'Urgente' || safeString(n.Tipo) === 'Letreiro')) : [];
            const banners = Array.isArray(sheetData['NOVIDADES_E_EVENTOS']) ? sheetData['NOVIDADES_E_EVENTOS'].filter(n => n && safeString(n.Tipo) !== 'Urgente' && safeString(n.Tipo) !== 'Letreiro' && (n.T√≠tulo || n.Mensagem)) : [];

            const foundMenu = menus.concat(adminMenus).find(m => m.id === activeTab);
            const titleTab = foundMenu ? foundMenu.label : activeTab;

            return (
                <div className="min-h-screen flex flex-col md:flex-row overflow-hidden relative selection:bg-primary selection:text-white">
                    {toast.show && <div className={`fixed bottom-8 right-8 z-[9999] px-8 py-5 rounded-custom shadow-2xl text-white font-black text-lg animate-slide-up bg-green-500`}><i className="ph-bold ph-check-circle text-2xl"></i> {toast.message}</div>}

                    {activeTab === 'Home' && Array.isArray(sheetData['ANIVERSARIOS']) && sheetData['ANIVERSARIOS'].filter(u=>u && safeString(u['Data de Nascimento']).substring(0,5) === new Date().toLocaleDateString('pt-BR').substring(0,5)).map((a,i) => (
                        <div key={i} className={`balloon flex flex-col items-center ${i%2===0?'left-[10%] animate-[rise_10s_infinite]':'right-[15%] animate-[rise_13s_infinite_2s]'}`}><span className="text-7xl drop-shadow-xl filter">üéà</span><span className="bg-white/90 dark:bg-slate-800/90 backdrop-blur border dark:border-slate-700 px-4 py-1.5 rounded-full text-xs font-black text-purple-600 dark:text-purple-400 shadow-xl mt-2 uppercase tracking-widest">Parab√©ns {safeString(a['Nome Completo']).split(' ')[0]}!</span></div>
                    ))}

                    <aside className="w-80 bg-white dark:bg-slate-800 border-r border-gray-100 dark:border-slate-700 flex flex-col h-screen shrink-0 shadow-2xl z-30 transition-colors">
                        <div className="p-8 flex items-center border-b bg-gray-50/50 cursor-pointer" onClick={()=>{setActiveTab('Home'); loadData('Home');}}>
                            <div className="bg-primary text-white p-3 rounded-2xl mr-3"><i className="ph-fill ph-heartbeat text-3xl"></i></div>
                            <div><h1 className="text-2xl font-black leading-none">Portal</h1><span className="text-[10px] font-black text-primary uppercase">S√£o Vicente</span></div>
                        </div>
                        <div className="p-6 border-b border-gray-50 dark:border-slate-700 flex items-center gap-4">
                            {userFoto ? (
                                <img src={formatImageUrl(userFoto)} className="w-14 h-14 rounded-custom object-cover shadow-md shrink-0 border-2 border-white dark:border-slate-700" alt="Avatar" />
                            ) : (
                                <div className="w-14 h-14 rounded-custom bg-gradient-to-tr from-secondary to-orange-400 flex items-center justify-center text-white font-black text-2xl shadow-md shrink-0">{safeString(userName || 'U').charAt(0).toUpperCase()}</div>
                            )}
                            <div className="flex-1 overflow-hidden">
                                <p className="text-base font-black truncate text-gray-900 dark:text-white">{userName}</p>
                                <p className="text-[10px] font-black text-primary bg-primary/10 px-2 py-1 rounded-md inline-block mt-1 uppercase tracking-widest">{safeString(user[nivelKey] || 'Acesso')}</p>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar pb-8">
                            <div className="px-4 mb-2 mt-2 text-[10px] font-black text-gray-400 uppercase">Menu</div>
                            {menus.map(m => <button key={m.id} onClick={()=>{setActiveTab(m.id); loadData(m.id);}} className={`w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold transition-all ${activeTab===m.id?'bg-primary text-white shadow-xl scale-[1.02]':'text-gray-500 hover:bg-gray-100'}`}><i className={`ph-fill ${m.icon} text-xl`}></i> {m.label}</button>)}
                            
                            {isAdmin && (
                                <>
                                    <div className="px-4 mt-6 mb-2 text-[10px] font-black text-gray-400 uppercase">Admin</div>
                                    {adminMenus.map(m => <button key={m.id} onClick={()=>{setActiveTab(m.id); loadData(m.id);}} className={`w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold transition-all ${activeTab===m.id?'bg-gray-900 text-white shadow-xl scale-[1.02]':'text-gray-500 hover:bg-gray-100'}`}><i className={`ph-fill ${m.icon} text-xl`}></i> {m.label}</button>)}
                                </>
                            )}
                            <button onClick={()=>setUser(null)} className="w-full flex items-center gap-4 px-5 py-3 rounded-custom text-sm font-bold text-red-600 hover:bg-red-50 mt-8"><i className="ph-fill ph-sign-out text-xl"></i> Sair</button>
                        </div>
                    </aside>

                    <main className="flex-1 h-screen overflow-y-auto relative custom-scrollbar p-6 md:p-10">
                        <ErrorBoundary>
                            {loading && <div className="fixed inset-0 bg-white/70 backdrop-blur z-50 flex items-center justify-center"><div className="animate-spin h-12 w-12 border-4 border-t-primary rounded-full"></div></div>}

                            {activeTab === 'Home' && !loading && (
                                <div className="space-y-12 animate-fade-in max-w-[1400px] mx-auto">
                                    <ClockWidget lembretesData={sheetData['LEMBRETES_HORA']} />
                                    
                                    {Array.isArray(sheetData['CONTROLE_ATENDIMENTOS']) && sheetData['CONTROLE_ATENDIMENTOS'].filter(a => Number(a.Limite_Max||0) > 0 && (Number(a.Qtd_Atual||0)/Number(a.Limite_Max||1)) >= 0.9).length > 0 && (
                                        <div>
                                            <h3 className="text-2xl font-black text-red-600 flex items-center gap-3 mb-6"><i className="ph-fill ph-warning-circle animate-pulse"></i> Alertas Unimed</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                {sheetData['CONTROLE_ATENDIMENTOS'].filter(a => Number(a.Limite_Max||0) > 0 && (Number(a.Qtd_Atual||0)/Number(a.Limite_Max||1)) >= 0.9).map((a, i) => {
                                                    const qtd = Number(a.Qtd_Atual || 0); const max = Number(a.Limite_Max || 1);
                                                    const perc = (qtd / max) * 100; const isCritico = perc >= 100;
                                                    return (
                                                        <div key={i} className={`p-8 rounded-[2.5rem] shadow-xl border-4 ${isCritico ? 'bg-red-600 border-red-800 text-white' : 'bg-orange-50 border-orange-200 text-orange-900'}`}>
                                                            <div className="flex justify-between items-center mb-6"><span className="font-black text-2xl">{safeString(a.Profissional)}</span></div>
                                                            <div className="w-full bg-black/10 rounded-full h-4 mb-4"><div className={`h-4 rounded-full ${isCritico ? 'bg-white' : 'bg-orange-500'}`} style={{width: `${Math.min(perc, 100)}%`}}></div></div>
                                                            <p className="text-5xl font-black leading-none">{qtd} <span className="text-xl opacity-60">/ {max}</span></p>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    <div>
                                        <h3 className="text-3xl font-black mb-8">Acesso R√°pido</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-6 gap-6">
                                            {[ { l: 'Mural', i: 'ph-presentation-chart', bg:'bg-blue-50', c:'text-blue-600', t: 'MURAL_AVISOS' }, { l: 'Imagem', i: 'ph-bone', bg:'bg-green-50', c:'text-green-600', t: 'EXAMES DE IMAGEM' }, { l: 'Consultas', i: 'ph-stethoscope', bg:'bg-blue-50', c:'text-blue-600', t: 'CONSULTA E PROCEDIMENTOS' }, { l: 'Lab', i: 'ph-flask', bg:'bg-purple-50', c:'text-purple-600', t: 'EXAMES LABORATORIAIS' }, { l: 'Institutos', i: 'ph-buildings', bg:'bg-orange-50', c:'text-orange-600', t: 'INSTITUTOS' }, { l: 'Remo√ß√µes', i: 'ph-car', bg:'bg-yellow-50', c:'text-yellow-600', t: 'REMO√á√ïES' } ].map((d, i) => (
                                                <button key={i} onClick={()=>{setActiveTab(d.t);loadData(d.t)}} className={`${d.bg} ${d.c} p-6 rounded-[2rem] flex flex-col items-center gap-4 card-hover shadow-sm`}>
                                                    <i className={`ph-fill ${d.i} text-4xl`}></i><span className="font-black text-sm uppercase tracking-widest">{d.l}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'CHAT_MENSAGENS' && !loading && <ChatModerno chatData={sheetData['CHAT_MENSAGENS']} user={user} onSaveChat={api.saveRecord} onRefresh={()=>loadData('CHAT_MENSAGENS')} />}
                            {activeTab === 'ESCALAS' && !loading && <EscalasContainer sheetData={sheetData} user={user} onRefresh={()=>loadData('ESCALAS')} showToast={showToast} />}
                            {activeTab === 'DESIGN_INTERFACE' && !loading && <DesignInterfacePanel sheetData={sheetData} onRefresh={()=>loadData('CONFIGURACOES')} showToast={showToast} />}

                            {activeTab !== 'Home' && activeTab !== 'CHAT_MENSAGENS' && activeTab !== 'ESCALAS' && activeTab !== 'DESIGN_INTERFACE' && !loading && (
                                <DataTableGeneric title={titleTab} tabName={activeTab} data={sheetData[activeTab] || []} user={user} onRefresh={()=>loadData(activeTab)} showToast={showToast} />
                            )}
                        </ErrorBoundary>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
